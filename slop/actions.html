<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Items — KagamiOS Test Audit</title>
    <meta name="description" content="Prioritized action items to improve test quality and coverage.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>鏡</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&family=Bangers&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <style>
        .action-detail {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
        }

        .action-detail-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .action-detail h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .action-detail-body {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-dim);
        }

        .action-detail-body code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--surface2);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--flow);
        }

        .action-detail-body ul {
            margin: var(--space-md) 0;
            padding-left: var(--space-lg);
        }

        .action-detail-body li {
            margin-bottom: var(--space-xs);
        }

        .action-files {
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background: var(--surface2);
            border-radius: 8px;
        }

        .action-files-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
        }

        .action-files code {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            padding: 4px 0;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="grid-pattern"></div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand">
                <span class="nav-kanji">鏡</span>
                <span class="nav-title">Test Audit</span>
                <span class="nav-badge">v2.0</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Overview</a></li>
                <li><a href="index.html#pyramid">Pyramid</a></li>
                <li><a href="metrics.html">Metrics</a></li>
                <li><a href="analysis.html">Analysis</a></li>
                <li><a href="actions.html" class="active">Actions</a></li>
            </ul>
        </div>
    </nav>

    <!-- Header -->
    <section class="hero" style="min-height: 50vh; padding-top: 140px;">
        <h1>Action Items</h1>
        <p class="hero-sub">
            Prioritized fixes to improve test health. Sorted by impact.
        </p>
    </section>

    <!-- Summary -->
    <section class="metrics-section">
        <div class="section-title">Summary</div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-badge badge-fail">P0</span>
                </div>
                <div class="metric-value" style="color: var(--fail);">2</div>
                <div class="metric-label">Critical Issues</div>
                <div class="metric-detail">Blocking test execution</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-badge badge-warn">P1</span>
                </div>
                <div class="metric-value" style="color: var(--warn);">3</div>
                <div class="metric-label">High Priority</div>
                <div class="metric-detail">Test failures to fix</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-badge badge-info">P2</span>
                </div>
                <div class="metric-value" style="color: var(--crystal);">4</div>
                <div class="metric-label">Medium Priority</div>
                <div class="metric-detail">Quality improvements</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-badge badge-info">Total</span>
                </div>
                <div class="metric-value">9</div>
                <div class="metric-label">Action Items</div>
                <div class="metric-detail">All priorities combined</div>
            </div>
        </div>
    </section>

    <!-- P0 Actions -->
    <section class="actions-section">
        <div class="section-title">P0 — Critical (Blocking)</div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p0">P0</span>
                <h3>Fix Satellite Package Dependency Conflict</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> The satellite packages (<code>kagami_api</code>, <code>kagami_hal</code>,
                <code>kagami_math</code>, <code>kagami_observability</code>) require <code>kagami<2.0.0</code>
                but PyPI has an unrelated <code>kagami>=3.0</code> package. This blocks installation
                of 4 satellite packages, causing 124 test collection errors.

                <br><br>
                <strong>Impact:</strong> 124 tests cannot be collected. Unknown number of tests cannot run.

                <br><br>
                <strong>Solution Options:</strong>
                <ul>
                    <li>Rename the internal package to avoid PyPI conflict (e.g., <code>kagami-core</code>)</li>
                    <li>Pin exact version in requirements: <code>kagami @ ./</code> (local path)</li>
                    <li>Use namespace package: <code>kagami-ai</code> or similar</li>
                </ul>

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>satellites/api/pyproject.toml</code>
                    <code>satellites/hal/pyproject.toml</code>
                    <code>satellites/math/pyproject.toml</code>
                    <code>satellites/observability/pyproject.toml</code>
                </div>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p0">P0</span>
                <h3>Fix World Model Test Failures</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> 87 world model tests are failing due to API changes in the
                multi-step empowerment and VJEPA2 integration modules.

                <br><br>
                <strong>Impact:</strong> Core AI functionality may have regressions. World model is
                central to KagamiOS decision-making.

                <br><br>
                <strong>Root Causes:</strong>
                <ul>
                    <li><code>MultiStepEmpowerment</code> constructor signature changed</li>
                    <li><code>VJEPA2WorldModel.generate_mask</code> return type changed</li>
                    <li><code>ActiveInference.expected_free_energy</code> config validation stricter</li>
                </ul>

                <br>
                <strong>Solution:</strong> Update test fixtures to match current API. Add
                backwards-compatibility tests if API must remain stable.

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>tests/core/world_model/test_unified_world_model.py</code>
                    <code>tests/core/world_model/test_world_model_enhancements.py</code>
                    <code>tests/core/world_model/test_vjepa2_integration.py</code>
                </div>
            </div>
        </div>
    </section>

    <!-- P1 Actions -->
    <section class="actions-section">
        <div class="section-title">P1 — High Priority</div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p1">P1</span>
                <h3>Fix Consciousness Integration Tests</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> 28 consciousness integration tests failing due to
                zero-abstraction validation logic changes.

                <br><br>
                <strong>Failures:</strong>
                <ul>
                    <li><code>test_state_views_share_memory</code> — Memory sharing assertion fails</li>
                    <li><code>test_consciousness_energy_computation</code> — Energy calculation mismatch</li>
                    <li><code>test_checkpoint_save_load</code> — Serialization format changed</li>
                    <li><code>test_colony_state_views</code> — View creation fails</li>
                </ul>

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>tests/unit/unified_agents/test_perfect_consciousness_integration.py</code>
                </div>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p1">P1</span>
                <h3>Stabilize TLS Enforcement Tests</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> Environment detection logic is inconsistent between
                test and production modes, causing 15 TLS enforcement tests to fail.

                <br><br>
                <strong>Specific Issues:</strong>
                <ul>
                    <li><code>test_production_rejects_default_password</code> — Not detecting production mode</li>
                    <li><code>test_production_requires_api_key</code> — API key check bypassed</li>
                    <li><code>test_development_allows_no_api_key</code> — Incorrectly enforcing production rules</li>
                </ul>

                <br>
                <strong>Solution:</strong> Add explicit environment variable injection in test fixtures
                to control mode detection.

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>tests/unit/test_tls_enforcement.py</code>
                </div>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p1">P1</span>
                <h3>Update Contract Test Snapshots</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> 37 contract tests failing due to snapshot drift.
                Snapshots are out of date with current API responses.

                <br><br>
                <strong>Solution:</strong> Run <code>pytest --snapshot-update</code> after verifying
                API changes are intentional. Add snapshot update to CI workflow.

                <br><br>
                <strong>Caution:</strong> Review each snapshot diff manually before accepting.
                Snapshots may have drifted due to bugs, not intentional changes.
            </div>
        </div>
    </section>

    <!-- P2 Actions -->
    <section class="actions-section">
        <div class="section-title">P2 — Medium Priority</div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p2">P2</span>
                <h3>Add Satellite Functional Tests</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> Most satellite packages only have import tests.
                No functional coverage for HAL adapters, math utilities, or observability tools.

                <br><br>
                <strong>Satellites Needing Tests:</strong>
                <ul>
                    <li><code>kagami_hal</code> — Camera, VM, Peekaboo adapters</li>
                    <li><code>kagami_math</code> — Fano plane routing, geometry utilities</li>
                    <li><code>kagami_observability</code> — Metrics emission, tracing</li>
                    <li><code>kagami_smarthome</code> — Control4, Lutron, August integrations</li>
                </ul>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p2">P2</span>
                <h3>Fix Flaky Property Tests</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> 54 property tests failing intermittently due to
                timing issues, module state pollution, and Hypothesis edge cases.

                <br><br>
                <strong>Solutions:</strong>
                <ul>
                    <li>Add <code>@settings(deadline=None)</code> to timing-sensitive tests</li>
                    <li>Use <code>suppress_health_check=[HealthCheck.function_scoped_fixture]</code></li>
                    <li>Reset module state in fixtures</li>
                    <li>Increase <code>max_examples</code> for more thorough coverage</li>
                </ul>

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>tests/core/test_schema_property_based.py</code>
                    <code>tests/unit/test_property_expansion.py</code>
                </div>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p2">P2</span>
                <h3>Fix Memory Bridge Configuration</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> Memory bridge tests assume bridge is enabled by default,
                but it's now disabled by default. 12 tests failing.

                <br><br>
                <strong>Solution:</strong> Update test fixtures to explicitly enable memory bridge
                before running tests that depend on it.

                <div class="action-files">
                    <div class="action-files-title">Affected Files</div>
                    <code>tests/unit/test_memory_bridge_quick.py</code>
                </div>
            </div>
        </div>

        <div class="action-detail">
            <div class="action-detail-header">
                <span class="action-priority priority-p2">P2</span>
                <h3>Address Deprecation Warnings</h3>
            </div>
            <div class="action-detail-body">
                <strong>Problem:</strong> 1,053 deprecation warnings, mostly Pydantic V2 migration.

                <br><br>
                <strong>Primary Warnings:</strong>
                <ul>
                    <li>Pydantic: "Support for class-based config is deprecated, use ConfigDict instead"</li>
                    <li>Genesis: Same Pydantic issue in texture configs</li>
                </ul>

                <br>
                <strong>Solution:</strong> Migrate Pydantic models from class-based <code>Config</code>
                to <code>model_config = ConfigDict(...)</code>.
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-kanji">鏡</div>
            <p class="footer-text">
                9 action items identified • 2 critical • 3 high • 4 medium
            </p>
            <p class="footer-timestamp">
                Generated 2026-01-12 • Prioritized by impact
            </p>
        </div>
    </footer>
</body>
</html>
