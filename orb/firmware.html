<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kagami Orb â€” <em>Firmware</em> Architecture â€” Kagami Orb</title>
    <meta name="description" content="The Orb firmware runs on Raspberry Pi CM4 using Rust with the Tokio async runtime (NOT Embassy â€” Embassy is for bare-metal MCUs, CM4 runs Linux). This provides:">
    <meta name="theme-color" content="#0A0A0C">

    <!-- Open Graph -->
    <meta property="og:title" content="Kagami Orb â€” <em>Firmware</em> Architecture â€” Kagami Orb">
    <meta property="og:description" content="The Orb firmware runs on Raspberry Pi CM4 using Rust with the Tokio async runtime (NOT Embassy â€” Embassy is for bare-metal MCUs, CM4 runs Linux). This provides:">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://storage.googleapis.com/kagami-media-public/orb/firmware.html">
    <meta name="twitter:card" content="summary">

    <!-- Fonts: Cormorant Garamond (display) + IBM Plex (body/mono) + Noto Sans JP (kanji) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400;1,500&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@100;200;300&display=swap" rel="stylesheet">

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KAGAMI ORB DOCUMENTATION â€” DESIGN SYSTEM v4.0
           Unified with ~/projects/art/ design language
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        :root {
            /* Core palette â€” matched to art projects */
            --void: #0A0A0C;
            --void-deep: #05050A;
            --void-elevated: #0f0e14;
            --void-surface: #16141f;
            --void-hover: #1d1b26;

            /* Gold spectrum */
            --gold: #D4AF37;
            --gold-bright: #E5C158;
            --gold-dim: rgba(212, 175, 55, 0.6);
            --gold-faint: rgba(212, 175, 55, 0.3);
            --gold-glow: rgba(212, 175, 55, 0.15);
            --gold-whisper: rgba(212, 175, 55, 0.06);

            /* Accent colors */
            --cyan: #3dd6d0;
            --cyan-dim: rgba(61, 214, 208, 0.4);
            --success: #4ECB71;
            --warning: #FF9F40;
            --error: #FF6B6B;

            /* Text hierarchy â€” WCAG AA compliant */
            --text: #F4F1EA;
            --text-secondary: rgba(244, 241, 234, 0.75);
            --text-tertiary: rgba(244, 241, 234, 0.55);
            --text-ghost: rgba(244, 241, 234, 0.35);
            --text-muted: rgba(244, 241, 234, 0.2);

            /* Borders & surfaces */
            --border: rgba(255, 255, 255, 0.06);
            --border-subtle: rgba(255, 255, 255, 0.03);
            --border-focus: rgba(212, 175, 55, 0.4);

            /* Typography scale (Major Third 1.25) */
            --text-xs: clamp(0.688rem, 0.65rem + 0.15vw, 0.75rem);
            --text-sm: clamp(0.813rem, 0.77rem + 0.17vw, 0.875rem);
            --text-base: clamp(1rem, 0.95rem + 0.2vw, 1.063rem);
            --text-lg: clamp(1.125rem, 1.05rem + 0.3vw, 1.25rem);
            --text-xl: clamp(1.424rem, 1.25rem + 0.7vw, 1.953rem);
            --text-2xl: clamp(1.802rem, 1.5rem + 1.2vw, 2.441rem);
            --text-3xl: clamp(2.281rem, 1.8rem + 2vw, 3.052rem);
            --text-4xl: clamp(2.887rem, 2.2rem + 3vw, 3.815rem);

            /* Spacing (8px grid) */
            --space-1: 0.5rem;
            --space-2: 1rem;
            --space-3: 1.5rem;
            --space-4: 2rem;
            --space-5: 2.5rem;
            --space-6: 3rem;
            --space-8: 4rem;
            --space-10: 5rem;

            /* Animation */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
            --duration-fast: 150ms;
            --duration-normal: 300ms;
            --duration-slow: 500ms;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & BASE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::selection {
            background: var(--gold);
            color: var(--void);
        }

        html {
            scroll-behavior: smooth;
            font-size: 17px;
            scroll-padding-top: 5rem;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--void);
            color: var(--text);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Film grain overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.015;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        /* Subtle gradient background */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 50% -20%, var(--gold-whisper), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(61, 214, 208, 0.02), transparent);
            pointer-events: none;
            z-index: -1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: linear-gradient(to bottom,
                rgba(10, 10, 12, 0.95),
                rgba(10, 10, 12, 0.85));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
        }

        .nav-brand {
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 200;
            font-size: var(--text-xl);
            color: var(--gold);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        .nav-brand:hover {
            color: var(--gold-bright);
            text-shadow: 0 0 30px var(--gold-glow);
        }

        .nav-brand .kanji {
            font-size: 1.8rem;
            transition: transform var(--duration-slow) var(--ease-out-expo);
        }

        .nav-brand:hover .kanji {
            transform: scale(1.1);
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .nav-links a,
        .nav-dropdown-btn {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: var(--text-sm);
            font-weight: 400;
            padding: var(--space-1) var(--space-2);
            border-radius: 6px;
            transition: all var(--duration-fast) var(--ease-out-expo);
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .nav-links a:hover,
        .nav-dropdown-btn:hover {
            color: var(--text);
            background: var(--gold-whisper);
        }

        .nav-links a.active {
            color: var(--gold);
            background: var(--gold-whisper);
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + var(--space-1));
            background: var(--void-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 200px;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.3),
                0 20px 40px -8px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            padding: var(--space-1);
            opacity: 0;
            transform: translateY(-8px);
            transition: all var(--duration-normal) var(--ease-out-expo);
        }

        .nav-dropdown:hover .nav-dropdown-content,
        .nav-dropdown:focus-within .nav-dropdown-content {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .nav-dropdown-content a {
            display: flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: var(--text-sm);
            border-radius: 8px;
            transition: all var(--duration-fast) var(--ease-out-expo);
        }

        .nav-dropdown-content a:hover {
            background: var(--gold-whisper);
            color: var(--gold);
            padding-left: var(--space-3);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: var(--space-1) var(--space-2);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CONTENT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        main {
            max-width: 900px;
            margin: 0 auto;
            padding: calc(64px + var(--space-8)) var(--space-6) var(--space-8);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DOCUMENT HEADER â€” Signature Title Treatment
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .doc-header {
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--border);
            position: relative;
            text-align: center;
        }

        /* Gold accent line */
        .doc-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }

        /* Display title â€” Cormorant Garamond */
        .doc-header h1 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: var(--text-4xl);
            font-weight: 300;
            color: var(--text);
            margin-bottom: var(--space-3);
            line-height: 1.15;
            letter-spacing: -0.02em;
        }

        /* Accent words in titles */
        .doc-header h1 em {
            font-style: italic;
            color: var(--gold);
            font-weight: 400;
        }

        .doc-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--space-4);
            font-size: var(--text-sm);
            color: var(--text-ghost);
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.05em;
        }

        .doc-meta span {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TYPOGRAPHY
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .content > *:first-child {
            margin-top: 0;
        }

        h2 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: var(--text-2xl);
            font-weight: 400;
            color: var(--text);
            margin-top: var(--space-8);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border);
            position: relative;
            letter-spacing: -0.01em;
        }

        h2::before {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--gold-dim);
        }

        /* Accent words in H2 */
        h2 em {
            font-style: italic;
            color: var(--gold);
        }

        h3 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: var(--text-xl);
            font-weight: 500;
            color: var(--gold);
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
            letter-spacing: -0.01em;
        }

        h4 {
            font-size: var(--text-lg);
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: var(--space-5);
            margin-bottom: var(--space-2);
        }

        p {
            margin-bottom: var(--space-3);
            color: var(--text-secondary);
        }

        strong {
            font-weight: 600;
            color: var(--text);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LINKS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        a {
            color: var(--cyan);
            text-decoration: none;
            transition: all var(--duration-fast) var(--ease-out-expo);
        }

        a:hover {
            color: var(--gold);
        }

        .content a {
            background: linear-gradient(to right, var(--gold-dim), var(--gold-dim)) no-repeat right bottom;
            background-size: 0% 1px;
            transition: background-size var(--duration-normal) var(--ease-out-expo), color var(--duration-fast);
        }

        .content a:hover {
            background-size: 100% 1px;
            background-position: left bottom;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LISTS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        ul, ol {
            margin-bottom: var(--space-3);
            padding-left: var(--space-5);
            color: var(--text-secondary);
        }

        li {
            margin-bottom: var(--space-1);
        }

        li::marker {
            color: var(--gold-dim);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TABLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .table-wrapper {
            overflow-x: auto;
            margin: var(--space-5) 0;
            border-radius: 12px;
            background: var(--void-elevated);
            border: 1px solid var(--border);
            box-shadow:
                0 1px 3px rgba(0, 0, 0, 0.2),
                0 8px 24px -4px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 var(--border-subtle);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }

        thead {
            background: linear-gradient(to bottom, var(--void-surface), var(--void-elevated));
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th {
            padding: var(--space-3) var(--space-3);
            text-align: left;
            font-weight: 500;
            color: var(--gold);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            font-family: 'IBM Plex Mono', monospace;
        }

        td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            transition: all var(--duration-fast) var(--ease-out-expo);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: all var(--duration-fast) var(--ease-out-expo);
        }

        tbody tr:hover {
            background: var(--gold-whisper);
        }

        tbody tr:hover td {
            color: var(--text);
        }

        /* Code in tables */
        td code, th code {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9em;
        }

        /* Status badges */
        .status-validated { color: var(--success); }
        .status-warning { color: var(--warning); }
        .status-deprecated {
            color: var(--error);
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CODE BLOCKS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        pre {
            background: var(--void-deep);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: var(--space-4);
            overflow-x: auto;
            margin: var(--space-5) 0;
            font-size: var(--text-sm);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        code {
            font-family: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.9em;
        }

        :not(pre) > code {
            background: var(--void-surface);
            padding: 0.15em 0.4em;
            border-radius: 4px;
            color: var(--cyan);
            border: 1px solid var(--border-subtle);
        }

        pre code {
            color: var(--text-secondary);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BLOCKQUOTES & ALERTS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        blockquote {
            border-left: 3px solid var(--gold);
            padding: var(--space-3) var(--space-4);
            margin: var(--space-5) 0;
            background: var(--gold-whisper);
            border-radius: 0 12px 12px 0;
            color: var(--text-secondary);
            font-style: italic;
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: var(--text-lg);
        }

        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, var(--border), var(--border-subtle), transparent);
            margin: var(--space-8) 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FOOTER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        footer {
            margin-top: var(--space-10);
            padding: var(--space-6) 0;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        footer .kanji {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 2.5rem;
            color: var(--gold-dim);
            margin-bottom: var(--space-2);
            opacity: 0.5;
            animation: breathe 5s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.6; }
        }

        footer p {
            color: var(--text-ghost);
            font-size: var(--text-sm);
            margin-bottom: 0;
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.05em;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BACK TO TOP
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .back-to-top {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--void-elevated);
            border: 1px solid var(--border);
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all var(--duration-normal) var(--ease-out-expo);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .back-to-top:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: var(--void-surface);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 30px var(--gold-glow);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PRINT STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        @media print {
            .top-nav, .back-to-top { display: none; }
            body { background: white; color: black; }
            body::before, body::after { display: none; }
            main { padding: 0; max-width: 100%; }
            a { color: inherit; }
            table, th, td { border: 1px solid #ddd; }
            .table-wrapper { box-shadow: none; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        @media (max-width: 768px) {
            .top-nav {
                padding: 0 var(--space-3);
            }

            .nav-links a:not(:first-child):not(:last-child) {
                display: none;
            }

            main {
                padding: calc(64px + var(--space-5)) var(--space-3) var(--space-5);
            }

            .doc-header h1 {
                font-size: var(--text-3xl);
            }

            h2 { font-size: var(--text-xl); }
            h3 { font-size: var(--text-lg); }

            .table-wrapper {
                margin-left: calc(-1 * var(--space-3));
                margin-right: calc(-1 * var(--space-3));
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            table { font-size: var(--text-xs); }
            th, td { padding: var(--space-1) var(--space-2); }

            .doc-meta { gap: var(--space-2); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCROLLBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--void);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-ghost);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ACCESSIBILITY
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        :focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        :target {
            scroll-margin-top: calc(64px + var(--space-5));
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <a href="index.html" class="nav-brand">
            <span class="kanji">é¡</span>
            <span>Kagami Orb</span>
        </a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="bom.html">BOM</a>
            <a href="buy.html">Buy</a>
            <a href="assembly.html">Assembly</a>
            <a href="spec.html">Spec</a>
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn">More â–¾</button>
                <div class="nav-dropdown-content">
                    <a href="alternatives.html">Alternatives</a>
                    <a href="custom-pcb.html">Custom PCB</a>
                    <a href="thermal.html">Thermal Analysis</a>
                    <a href="fmea.html">FMEA</a>
                    <a href="firmware.html">Firmware</a>
                    <a href="system.html">System Design</a>
                    <a href="validation.html">Validation Plan</a>
                    <div class="nav-dropdown-divider"></div>
                    <a href="hardware/kagami_orb_bom.csv" download>ğŸ“¥ Download CSV</a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <article class="doc-header">
            <h1>Kagami Orb â€” <em>Firmware</em> Architecture</h1>
            <div class="doc-meta">
                <span>January 11, 2026</span>
                <span>v2.0</span>
            </div>
        </article>

        <div class="content">
            <h2 id="overview">Overview</h2>
<p>The Orb firmware runs on Raspberry Pi CM4 using <strong>Rust</strong> with the <strong>Tokio</strong> async runtime (NOT Embassy â€” Embassy is for bare-metal MCUs, CM4 runs Linux). This provides:<br />
- Zero-cost async/await for real-time responsiveness<br />
- Memory safety without garbage collection<br />
- Predictable latency for audio and LED control<br />
- Cross-platform development (same code runs on dev machine)</p>
<hr />
<h2 id="technology-stack">Technology Stack</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FIRMWARE STACK                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  APPLICATION LAYER                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Voice    â”‚ â”‚    LED     â”‚ â”‚   Power    â”‚ â”‚    API     â”‚                   â”‚
â”‚  â”‚  Pipeline  â”‚ â”‚  Animator  â”‚ â”‚  Manager   â”‚ â”‚   Client   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚              â”‚              â”‚              â”‚                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚                                                                                  â”‚
â”‚  SERVICE LAYER                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   State    â”‚ â”‚   Event    â”‚ â”‚  Config    â”‚ â”‚   Logger   â”‚                   â”‚
â”‚  â”‚  Machine   â”‚ â”‚    Bus     â”‚ â”‚  Manager   â”‚ â”‚            â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚              â”‚              â”‚              â”‚                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚                                                                                  â”‚
â”‚  HAL LAYER (Hardware Abstraction)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚    I2S     â”‚ â”‚    SPI     â”‚ â”‚    I2C     â”‚ â”‚   GPIO     â”‚                   â”‚
â”‚  â”‚   Audio    â”‚ â”‚    LEDs    â”‚ â”‚   Sensors  â”‚ â”‚   Control  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚              â”‚              â”‚              â”‚                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚                                                                                  â”‚
â”‚  TOKIO RUNTIME (Linux userspace)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Async executor  â”‚  Timer  â”‚  Channels    â”‚  I/O  â”‚  Networking        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â”‚  LINUX KERNEL (Raspberry Pi OS Lite)                                            â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="directory-structure">Directory Structure</h2>
<pre><code>apps/hub/kagami-orb/firmware/orb/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ build.rs
â”œâ”€â”€ memory.x                      # Memory layout
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ default.toml              # Default configuration
â”‚   â””â”€â”€ production.toml           # Production settings
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                   # Entry point
â”‚   â”œâ”€â”€ lib.rs                    # Library root
â”‚   â”‚
â”‚   â”œâ”€â”€ state/                    # State Machine
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ orb_state.rs          # Main state enum
â”‚   â”‚   â”œâ”€â”€ transitions.rs        # State transition logic
â”‚   â”‚   â””â”€â”€ persistence.rs        # State persistence
â”‚   â”‚
â”‚   â”œâ”€â”€ voice/                    # Voice Pipeline
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ capture.rs            # Audio capture (I2S)
â”‚   â”‚   â”œâ”€â”€ vad.rs                # Voice activity detection
â”‚   â”‚   â”œâ”€â”€ wake_word.rs          # Wake word detection
â”‚   â”‚   â”œâ”€â”€ beamforming.rs        # Mic array processing
â”‚   â”‚   â””â”€â”€ streaming.rs          # Audio to API
â”‚   â”‚
â”‚   â”œâ”€â”€ led/                      # LED Control
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ ring.rs               # SK6812 driver
â”‚   â”‚   â”œâ”€â”€ patterns.rs           # Animation patterns
â”‚   â”‚   â”œâ”€â”€ colony_colors.rs      # Color definitions
â”‚   â”‚   â””â”€â”€ animator.rs           # Animation scheduler
â”‚   â”‚
â”‚   â”œâ”€â”€ power/                    # Power Management
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ battery.rs            # BQ40Z50 fuel gauge
â”‚   â”‚   â”œâ”€â”€ charger.rs            # BQ25895 charger
â”‚   â”‚   â”œâ”€â”€ resonant_rx.rs        # Resonant wireless power (NOT Qi)
â”‚   â”‚   â””â”€â”€ sleep.rs              # Low power modes
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                      # API Client
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ client.rs             # HTTP client
â”‚   â”‚   â”œâ”€â”€ websocket.rs          # WebSocket connection
â”‚   â”‚   â”œâ”€â”€ orb_state.rs          # State sync
â”‚   â”‚   â””â”€â”€ voice_proxy.rs        # Voice streaming
â”‚   â”‚
â”‚   â”œâ”€â”€ sensors/                  # Sensor Integration
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ hall_effect.rs        # Dock detection
â”‚   â”‚   â”œâ”€â”€ temperature.rs        # Thermal monitoring
â”‚   â”‚   â””â”€â”€ accelerometer.rs      # Motion detection (optional)
â”‚   â”‚
â”‚   â”œâ”€â”€ hal/                      # Hardware Abstraction
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ i2s.rs                # Audio I/O
â”‚   â”‚   â”œâ”€â”€ spi.rs                # LED data
â”‚   â”‚   â”œâ”€â”€ i2c.rs                # Sensor bus
â”‚   â”‚   â””â”€â”€ gpio.rs               # Digital I/O
â”‚   â”‚
â”‚   â””â”€â”€ util/                     # Utilities
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ config.rs             # Configuration loading
â”‚       â”œâ”€â”€ logger.rs             # Logging setup
â”‚       â””â”€â”€ event_bus.rs          # Inter-task communication
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ integration/
    â”‚   â”œâ”€â”€ state_machine_test.rs
    â”‚   â”œâ”€â”€ led_animation_test.rs
    â”‚   â””â”€â”€ api_client_test.rs
    â””â”€â”€ unit/
        â””â”€â”€ ...
</code></pre>
<hr />
<h2 id="state-machine">State Machine</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORB STATE MACHINE                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    STARTUP      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚          â”‚                 â”‚          â”‚
                   â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                   â”‚                   â”‚                   â”‚
                   â”‚                   â”‚ init complete     â”‚ init failed
                   â”‚                   â–¼                   â–¼
                   â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚          â”‚                 â”‚  â”‚                 â”‚
                   â”‚          â”‚     IDLE        â”‚  â”‚     ERROR       â”‚
                   â”‚          â”‚   (Breathing)   â”‚  â”‚   (Red pulse)   â”‚
                   â”‚          â”‚                 â”‚  â”‚                 â”‚
                   â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                   â”‚                    â”‚
                   â”‚      wake word    â”‚                    â”‚ recovery
                   â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                   â”‚          â–¼                 â”‚           â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚           â”‚
                   â”‚  â”‚                 â”‚       â”‚           â”‚
                   â”‚  â”‚   LISTENING     â”‚â—„â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  â”‚   (Blue pulse)  â”‚
                   â”‚  â”‚                 â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚           â”‚
                   â”‚           â”‚ speech detected
                   â”‚           â–¼
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  â”‚                 â”‚
                   â”‚  â”‚   CAPTURING     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  â”‚   (Blue solid)  â”‚                   â”‚
                   â”‚  â”‚                 â”‚                   â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                   â”‚           â”‚                            â”‚
                   â”‚           â”‚ speech complete            â”‚ timeout
                   â”‚           â–¼                            â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
                   â”‚  â”‚                 â”‚                   â”‚
                   â”‚  â”‚   PROCESSING    â”‚                   â”‚
                   â”‚  â”‚ (Purple spin)   â”‚                   â”‚
                   â”‚  â”‚                 â”‚                   â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                   â”‚           â”‚                            â”‚
                   â”‚           â”‚ response ready             â”‚
                   â”‚           â–¼                            â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
                   â”‚  â”‚                 â”‚                   â”‚
                   â”‚  â”‚   RESPONDING    â”‚                   â”‚
                   â”‚  â”‚ (Colony color)  â”‚                   â”‚
                   â”‚  â”‚                 â”‚                   â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                   â”‚           â”‚                            â”‚
                   â”‚           â”‚ complete                   â”‚
                   â”‚           â–¼                            â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
                                                            â–¼
                                                   (return to IDLE)


SPECIAL STATES (can interrupt any state):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚   UNDOCKED      â”‚     â”‚  BATTERY_LOW    â”‚     â”‚   SAFETY_HALT   â”‚
â”‚  (Portable)     â”‚     â”‚  (Amber warn)   â”‚     â”‚   (Red frozen)  â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘                       â†‘                       â†‘
    â”‚ lift detected         â”‚ &lt;20% SOC              â”‚ h(x) = 0
    â”‚                       â”‚                       â”‚
â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    (interrupts from any state)
</code></pre>
<h3 id="state-definition-rust">State Definition (Rust)</h3>
<pre><code class="language-rust">/// Primary orb state machine
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum OrbState {
    /// Initial boot sequence
    Startup,

    /// Idle, breathing animation, waiting for wake word
    Idle,

    /// Wake word detected, listening for command
    Listening,

    /// Actively capturing speech
    Capturing { start_time: Instant },

    /// Processing command via API
    Processing { request_id: u64 },

    /// Speaking response
    Responding { colony: Colony },

    /// Unrecoverable error
    Error { code: ErrorCode },

    /// Undocked, running on battery
    Undocked { battery_soc: u8 },

    /// Battery critically low
    BatteryLow { soc: u8 },

    /// Safety violation, commands blocked
    SafetyHalt { reason: SafetyReason },
}

/// Colony identifier for color mapping
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum Colony {
    Spark,
    Forge,
    Flow,
    Nexus,
    Beacon,
    Grove,
    Crystal,
}

impl Colony {
    pub fn color(&amp;self) -&gt; Rgb {
        match self {
            Colony::Spark   =&gt; Rgb::new(255, 107, 53),   // #FF6B35
            Colony::Forge   =&gt; Rgb::new(255, 179, 71),   // #FFB347
            Colony::Flow    =&gt; Rgb::new(78, 205, 196),   // #4ECDC4
            Colony::Nexus   =&gt; Rgb::new(155, 89, 182),   // #9B59B6
            Colony::Beacon  =&gt; Rgb::new(212, 175, 55),   // #D4AF37
            Colony::Grove   =&gt; Rgb::new(39, 174, 96),    // #27AE60
            Colony::Crystal =&gt; Rgb::new(224, 224, 224),  // #E0E0E0
        }
    }
}
</code></pre>
<hr />
<h2 id="task-architecture">Task Architecture</h2>
<p>Tokio uses cooperative async tasks. Each task runs on a thread pool but yields at await points.</p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TASK ARCHITECTURE                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HIGH PRIORITY (real-time sensitive)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ audio_capture   â”‚  Priority: HIGHEST
â”‚                 â”‚  Period: 16kHz continuous
â”‚                 â”‚  DMA-driven, minimal CPU
â”‚                 â”‚  Feeds: wake_word, voice_stream
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ led_driver      â”‚  Priority: HIGH
â”‚                 â”‚  Period: 60 FPS (16.6ms)
â”‚                 â”‚  DMA-driven SPI
â”‚                 â”‚  Reads: led_state channel
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MEDIUM PRIORITY (responsive)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wake_word       â”‚  Priority: MEDIUM
â”‚                 â”‚  Period: 32ms windows
â”‚                 â”‚  Porcupine/openWakeWord
â”‚                 â”‚  Signals: state_machine
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state_machine   â”‚  Priority: MEDIUM
â”‚                 â”‚  Event-driven
â”‚                 â”‚  Coordinates all tasks
â”‚                 â”‚  Publishes: led_state, api_state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api_client      â”‚  Priority: MEDIUM
â”‚                 â”‚  WebSocket + HTTP
â”‚                 â”‚  Bidirectional state sync
â”‚                 â”‚  Handles: commands, responses
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LOW PRIORITY (background)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ power_monitor   â”‚  Priority: LOW
â”‚                 â”‚  Period: 1 second
â”‚                 â”‚  I2C to BQ40Z50
â”‚                 â”‚  Reports: battery state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ thermal_monitor â”‚  Priority: LOW
â”‚                 â”‚  Period: 5 seconds
â”‚                 â”‚  Reads: temp sensors
â”‚                 â”‚  Triggers: throttling
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ heartbeat       â”‚  Priority: LOWEST
â”‚                 â”‚  Period: 30 seconds
â”‚                 â”‚  API keepalive
â”‚                 â”‚  Reports: orb status
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="task-implementation-rust">Task Implementation (Rust)</h3>
<pre><code class="language-rust">use tokio::sync::mpsc::{channel, Sender, Receiver};
use tokio::time::{Duration, interval};

/// Main entry point
#[tokio::main]
async fn main() {
    // Initialize hardware
    let peripherals = init_peripherals();

    // Create shared channels
    let (led_tx, led_rx) = channel::&lt;LedCommand, 16&gt;();
    let (state_tx, state_rx) = channel::&lt;StateEvent, 32&gt;();
    let (audio_tx, audio_rx) = channel::&lt;AudioFrame, 64&gt;();

    // Spawn tasks
    spawner.spawn(audio_capture(peripherals.i2s, audio_tx)).unwrap();
    spawner.spawn(led_driver(peripherals.spi, led_rx)).unwrap();
    spawner.spawn(wake_word_detector(audio_rx.clone(), state_tx.clone())).unwrap();
    spawner.spawn(state_machine(state_rx, led_tx, api_tx)).unwrap();
    spawner.spawn(api_client(api_rx, state_tx.clone())).unwrap();
    spawner.spawn(power_monitor(peripherals.i2c, state_tx.clone())).unwrap();
    spawner.spawn(thermal_monitor(peripherals.i2c, state_tx.clone())).unwrap();
    spawner.spawn(heartbeat(api_tx.clone())).unwrap();

    // Main loop handles unexpected termination
    loop {
        Timer::after(Duration::from_secs(3600)).await;
    }
}

/// Audio capture task - DMA-driven I2S
#[embassy_executor::task]
async fn audio_capture(
    i2s: I2sPeripheral,
    audio_tx: Sender&lt;AudioFrame&gt;,
) {
    let mut buffer = [0i16; 512]; // 32ms at 16kHz

    loop {
        // DMA fills buffer, await completes when ready
        i2s.read_dma(&amp;mut buffer).await;

        let frame = AudioFrame::new(&amp;buffer);
        let _ = audio_tx.try_send(frame); // Non-blocking
    }
}

/// LED driver task - SPI to SK6812
#[embassy_executor::task]
async fn led_driver(
    spi: SpiPeripheral,
    led_rx: Receiver&lt;LedCommand&gt;,
) {
    let mut ring = Sk6812Ring::new(spi, 24);
    let mut animator = LedAnimator::new();

    loop {
        // Check for new commands (non-blocking)
        if let Ok(cmd) = led_rx.try_receive() {
            animator.apply_command(cmd);
        }

        // Compute next frame
        let frame = animator.tick();
        ring.write(&amp;frame).await;

        // 60 FPS target
        Timer::after(Duration::from_millis(16)).await;
    }
}

/// State machine task - event-driven coordinator
#[embassy_executor::task]
async fn state_machine(
    state_rx: Receiver&lt;StateEvent&gt;,
    led_tx: Sender&lt;LedCommand&gt;,
    api_tx: Sender&lt;ApiCommand&gt;,
) {
    let mut state = OrbState::Startup;

    loop {
        let event = state_rx.receive().await;

        // Process event and compute next state
        let (next_state, actions) = state.transition(event);

        // Execute actions
        for action in actions {
            match action {
                Action::SetLed(cmd) =&gt; led_tx.send(cmd).await,
                Action::SendApi(cmd) =&gt; api_tx.send(cmd).await,
                Action::PlayAudio(clip) =&gt; play_audio(clip).await,
            }
        }

        state = next_state;
    }
}
</code></pre>
<hr />
<h2 id="gpio-assignments">GPIO Assignments</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GPIO PIN ASSIGNMENTS                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  I2S AUDIO (ReSpeaker + Speaker)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  GPIO12 (PCM_CLK)  â†’ I2S BCLK (shared)                                          â”‚
â”‚  GPIO19 (PCM_FS)   â†’ I2S LRCLK (shared)                                         â”‚
â”‚  GPIO20 (PCM_DIN)  â† ReSpeaker Data Out                                         â”‚
â”‚  GPIO21 (PCM_DOUT) â†’ MAX98357A Data In                                          â”‚
â”‚                                                                                  â”‚
â”‚  SPI (LED Ring)                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  GPIO10 (SPI_MOSI) â†’ SK6812 DIN (via level shifter)                             â”‚
â”‚  GPIO11 (SPI_SCLK) â†’ (unused, but reserved)                                     â”‚
â”‚                                                                                  â”‚
â”‚  I2C (Sensors + Power ICs)                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  GPIO2 (SDA)       â†” I2C Bus                                                    â”‚
â”‚  GPIO3 (SCL)       â†’ I2C Bus                                                    â”‚
â”‚                                                                                  â”‚
â”‚  I2C DEVICES:                                                                    â”‚
â”‚  â”œâ”€â”€ 0x6A: BQ25895 (Charger)                                                    â”‚
â”‚  â”œâ”€â”€ 0x0B: BQ40Z50 (Fuel Gauge) â€” SMBus                                         â”‚
â”‚  â”œâ”€â”€ 0x35: ReSpeaker (XMOS config)                                              â”‚
â”‚  â””â”€â”€ 0x48: TMP117 (Temperature)                                                 â”‚
â”‚                                                                                  â”‚
â”‚  GPIO (Digital I/O)                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  GPIO17 (INPUT)    â† Resonant charging status                                   â”‚
â”‚  GPIO22 (INPUT)    â† Hall sensor (dock detect)                                  â”‚
â”‚  GPIO23 (INPUT)    â† Temperature alert                                          â”‚
â”‚  GPIO24 (INPUT)    â† ReSpeaker voice activity                                   â”‚
â”‚  GPIO27 (INPUT)    â† Battery alert (low/critical)                               â”‚
â”‚  GPIO25 (OUTPUT)   â†’ Status LED (debug)                                         â”‚
â”‚  GPIO26 (OUTPUT)   â†’ Amplifier enable                                           â”‚
â”‚                                                                                  â”‚
â”‚  RESERVED FOR EXPANSION                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  GPIO4, GPIO5, GPIO6, GPIO13, GPIO16                                            â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="memory-map">Memory Map</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEMORY ALLOCATION                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  CM4 4GB RAM ALLOCATION (Linux userspace)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚                                                                                  â”‚
â”‚  0x0000_0000 - 0x3FFF_FFFF (1GB)   Kernel + System                              â”‚
â”‚                                                                                  â”‚
â”‚  0x4000_0000 - 0x7FFF_FFFF (1GB)   Kagami Orb Process                           â”‚
â”‚  â”œâ”€â”€ 256 MB: Audio buffers (ring buffers, streaming)                            â”‚
â”‚  â”œâ”€â”€ 128 MB: LED frame buffers (double-buffered)                                â”‚
â”‚  â”œâ”€â”€ 256 MB: Wake word model (Porcupine/openWakeWord)                           â”‚
â”‚  â”œâ”€â”€ 128 MB: API client buffers                                                 â”‚
â”‚  â””â”€â”€ 256 MB: General heap                                                       â”‚
â”‚                                                                                  â”‚
â”‚  0x8000_0000 - 0xBFFF_FFFF (1GB)   Coral TPU shared memory                      â”‚
â”‚  â””â”€â”€ Model loading, inference tensors                                           â”‚
â”‚                                                                                  â”‚
â”‚  0xC000_0000 - 0xFFFF_FFFF (1GB)   Reserved / GPU                               â”‚
â”‚                                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  DMA CHANNELS                                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  Channel 0: I2S RX (audio capture) - HIGHEST priority                           â”‚
â”‚  Channel 1: I2S TX (audio playback)                                             â”‚
â”‚  Channel 2: SPI TX (LED data)                                                   â”‚
â”‚  Channel 3: Reserved                                                            â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="power-state-transitions">Power State Transitions</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         POWER STATE MACHINE                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                                      â”‚
                    â”‚                    POWERED_OFF                       â”‚
                    â”‚                                                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ Resonant power detected OR button press
                                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                                      â”‚
                    â”‚                    BOOTING                           â”‚
                    â”‚                                                      â”‚
                    â”‚  â€¢ Linux kernel loads                               â”‚
                    â”‚  â€¢ Embassy runtime starts                           â”‚
                    â”‚  â€¢ WiFi connects                                    â”‚
                    â”‚  â€¢ API handshake                                    â”‚
                    â”‚                                                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ init complete
                                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                                       â”‚
        â”‚                         DOCKED_ACTIVE                                 â”‚
        â”‚                                                                       â”‚
        â”‚  â€¢ Full functionality                                                 â”‚
        â”‚  â€¢ Resonant charging active                                            â”‚
        â”‚  â€¢ CPU: 1.5 GHz                                                       â”‚
        â”‚  â€¢ LEDs: Full brightness                                              â”‚
        â”‚  â€¢ Power consumption: 9.5W average                                    â”‚
        â”‚                                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                     â”‚
              lift detected    â”‚                     â”‚ idle &gt; 5 minutes
                               â–¼                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚   â”‚                            â”‚
        â”‚       UNDOCKED             â”‚   â”‚      DOCKED_IDLE           â”‚
        â”‚                            â”‚   â”‚                            â”‚
        â”‚  â€¢ Battery power           â”‚   â”‚  â€¢ Resonant charge (trickle)â”‚
        â”‚  â€¢ Reduced CPU (1.0 GHz)   â”‚   â”‚  â€¢ Reduced CPU (600 MHz)   â”‚
        â”‚  â€¢ LEDs: 15% brightness    â”‚   â”‚  â€¢ LEDs: 30% brightness    â”‚
        â”‚  â€¢ Power: 4W average       â”‚   â”‚  â€¢ Power: 3W average       â”‚
        â”‚                            â”‚   â”‚                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ SOC &lt; 20%
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚
        â”‚      BATTERY_LOW           â”‚
        â”‚                            â”‚
        â”‚  â€¢ Warning pulses          â”‚
        â”‚  â€¢ CPU: 600 MHz            â”‚
        â”‚  â€¢ Voice disabled          â”‚
        â”‚  â€¢ Power: 2W average       â”‚
        â”‚                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ SOC &lt; 5%
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚
        â”‚      SHUTDOWN              â”‚
        â”‚                            â”‚
        â”‚  â€¢ Graceful shutdown       â”‚
        â”‚  â€¢ Save state              â”‚
        â”‚  â€¢ Single red LED blink    â”‚
        â”‚  â€¢ Power off               â”‚
        â”‚                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


POWER BUDGET BY STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

| State         | CPU (GHz) | LEDs    | WiFi    | Audio   | Total  |
|---------------|-----------|---------|---------|---------|--------|
| DOCKED_ACTIVE | 1.5       | 100%    | Active  | Active  | 9.5W   |
| DOCKED_IDLE   | 0.6       | 30%     | Active  | Standby | 3.0W   |
| UNDOCKED      | 1.0       | 15%     | Active  | Active  | 4.0W   |
| BATTERY_LOW   | 0.6       | 10%     | Active  | Off     | 2.0W   |
</code></pre>
<hr />
<h2 id="voice-pipeline">Voice Pipeline</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VOICE PIPELINE                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    MIC ARRAY (4 channels)
           â”‚
           â”‚ I2S @ 16kHz, 16-bit
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   ReSpeaker     â”‚  Beamforming (XMOS hardware)
    â”‚   XMOS DSP      â”‚  Noise suppression
    â”‚                 â”‚  Echo cancellation (when speaker active)
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Single channel, enhanced
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   Ring Buffer   â”‚  512 samples (32ms) per frame
    â”‚   (Embassy)     â”‚  Triple buffer for lock-free
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Frame available
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   Wake Word     â”‚  Porcupine or openWakeWord
    â”‚   Detector      â”‚  &quot;Hey Kagami&quot; or &quot;Kagami&quot;
    â”‚                 â”‚  Threshold: 0.6
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Wake word detected
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   VAD           â”‚  Voice Activity Detection
    â”‚   (WebRTC)      â”‚  Determines speech boundaries
    â”‚                 â”‚  Timeout: 2 seconds silence
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Speech segment
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   Opus Encoder  â”‚  Compress for streaming
    â”‚                 â”‚  20ms frames, 24kbps
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ WebSocket
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   Kagami API    â”‚  /ws/orb/voice
    â”‚                 â”‚  Streaming recognition
    â”‚                 â”‚  Response streaming
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Audio response
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   Opus Decoder  â”‚  Decompress
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ PCM
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â”‚   MAX98357A     â”‚  I2S DAC + Class-D amp
    â”‚                 â”‚  3W into 4Î© speaker
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="ota-update-mechanism">OTA Update Mechanism</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         OTA UPDATE PROCESS                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PARTITION LAYOUT (A/B Scheme)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/dev/mmcblk0
â”œâ”€â”€ p1: boot_a (256MB)     # Kernel + DTB
â”œâ”€â”€ p2: boot_b (256MB)     # Backup kernel
â”œâ”€â”€ p3: root_a (4GB)       # Active rootfs
â”œâ”€â”€ p4: root_b (4GB)       # Backup rootfs
â””â”€â”€ p5: data (remaining)   # Persistent data


UPDATE SEQUENCE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. API NOTIFICATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Kagami API     â”‚ â†’ &quot;update available: v1.2.0&quot;
   â”‚                 â”‚    sha256: abc123...
   â”‚                 â”‚    size: 450MB
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. DOWNLOAD (Background)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Orb downloads  â”‚ â†’ /data/update/update.img
   â”‚  while active   â”‚    Resume on disconnect
   â”‚                 â”‚    Verify sha256
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. VERIFY SIGNATURE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Ed25519 sig    â”‚ â†’ Signed by Kagami key
   â”‚  verification   â”‚    Reject unsigned
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. INSTALL (Idle only)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Write to B     â”‚ â†’ flash to inactive partition
   â”‚  partition      â”‚    Verify after write
   â”‚                 â”‚    ~5 minutes
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. REBOOT
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Set boot flag  â”‚ â†’ Try B on next boot
   â”‚  Reboot         â”‚    LED: amber spin
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. VERIFICATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Boot B         â”‚ â†’ If success: commit B
   â”‚  Health check   â”‚    If fail: revert to A
   â”‚                 â”‚    3 boot attempts max
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


LED INDICATION DURING UPDATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ Downloading:    Slow blue pulse (0.5 Hz)
â€¢ Installing:     Amber spin (2 Hz)
â€¢ Rebooting:      All off, then boot sequence
â€¢ Failed/Revert:  Red triple-flash, then normal
</code></pre>
<hr />
<h2 id="build-deploy">Build &amp; Deploy</h2>
<pre><code class="language-bash"># Development build
cd apps/hub/kagami-orb/firmware/orb
cargo build --release --target aarch64-unknown-linux-gnu

# Run on development Pi
cargo run --release

# Cross-compile for CM4
cross build --release --target aarch64-unknown-linux-gnu

# Deploy to orb
scp target/aarch64-unknown-linux-gnu/release/kagami-orb kagami@orb.local:/opt/kagami/

# Systemd service
sudo systemctl enable kagami-orb
sudo systemctl start kagami-orb
</code></pre>
<hr />
<h2 id="configuration">Configuration</h2>
<pre><code class="language-toml"># config/default.toml

[general]
name = &quot;Kagami Orb&quot;
location = &quot;living_room&quot;

[api]
host = &quot;kagami.local&quot;
port = 8001
websocket_path = &quot;/ws/orb/stream&quot;
reconnect_interval_ms = 5000

[audio]
sample_rate = 16000
channels = 1
frame_size = 512
wake_word = &quot;hey kagami&quot;
wake_word_threshold = 0.6
vad_timeout_ms = 2000

[led]
num_leds = 24
brightness_max = 255
brightness_idle = 60
animation_fps = 60

[power]
battery_low_threshold = 20
battery_critical_threshold = 5
undocked_cpu_mhz = 1000
docked_idle_cpu_mhz = 600

[thermal]
warning_temp_c = 65
critical_temp_c = 75
throttle_temp_c = 70
</code></pre>
<hr />
<pre><code>é¡

h(x) â‰¥ 0. Always.

The firmware breathes life into the mirror.
Tasks await. Events flow. State persists.
Tokio orchestrates the dance.
</code></pre>
        </div>
    </main>

    <button class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="Back to top">â†‘</button>

    <footer>
        <div class="kanji">é¡</div>
        <p>h(x) â‰¥ 0 Â· Always</p>
    </footer>

    <script>
        // Back to top button
        const backToTop = document.querySelector('.back-to-top');
        let ticking = false;

        window.addEventListener('scroll', () => {
            if (!ticking) {
                requestAnimationFrame(() => {
                    backToTop.classList.toggle('visible', window.scrollY > 400);
                    ticking = false;
                });
                ticking = true;
            }
        });

        // Wrap tables
        document.querySelectorAll('table').forEach(table => {
            if (!table.parentElement.classList.contains('table-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }
        });

        // External links
        document.querySelectorAll('a[href^="http"]').forEach(link => {
            if (!link.href.includes(window.location.hostname)) {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            }
        });

        // Current page highlight
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.nav-links a').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    </script>
</body>
</html>
