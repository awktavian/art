# Kagami Orb Firmware CI/CD Workflow
#
# Tests the Rust embedded orb firmware across multiple platforms:
#   - Linux x86_64 (primary development)
#   - macOS ARM64 (Apple Silicon development)
#   - Cross-compilation for Raspberry Pi targets
#
# Test strategy:
#   - Unit tests run on all platforms
#   - Desktop feature tests on Linux/macOS
#   - Cross-compilation tests for Raspberry Pi targets

name: orb-firmware-ci

on:
  push:
    branches: [main]
    paths:
      - 'apps/hub/kagami-orb/firmware/orb/**'
      - '.github/workflows/orb-firmware-ci.yml'
  pull_request:
    paths:
      - 'apps/hub/kagami-orb/firmware/orb/**'
      - '.github/workflows/orb-firmware-ci.yml'

concurrency:
  group: orb-firmware-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # FAST GATE: Lint and Format Check
  # ============================================================================
  lint:
    name: Rust Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: apps/hub/kagami-orb/firmware/orb
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            apps/hub/kagami-orb/firmware/orb/target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('apps/hub/kagami-orb/firmware/orb/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy lint (desktop feature)
        run: cargo clippy --features desktop -- -D warnings

  # ============================================================================
  # UNIT TESTS (all platforms)
  # ============================================================================
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
    defaults:
      run:
        working-directory: apps/hub/kagami-orb/firmware/orb
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            apps/hub/kagami-orb/firmware/orb/target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('apps/hub/kagami-orb/firmware/orb/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Build (desktop feature)
        run: cargo build --features desktop --verbose

      - name: Run unit tests
        run: cargo test --lib --features desktop --verbose

      - name: Run doc tests
        run: cargo test --doc --features desktop --verbose

  # ============================================================================
  # CROSS-COMPILATION TESTS (Raspberry Pi targets)
  # ============================================================================
  cross-compile:
    name: Cross-Compile (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Raspberry Pi 4/5 (64-bit)
          - target: aarch64-unknown-linux-gnu
            cross: true
            features: "raspberry-pi"
          # Raspberry Pi 3 (32-bit)
          - target: armv7-unknown-linux-gnueabihf
            cross: true
            features: "raspberry-pi"
    defaults:
      run:
        working-directory: apps/hub/kagami-orb/firmware/orb
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            apps/hub/kagami-orb/firmware/orb/target
          key: ${{ runner.os }}-cargo-cross-${{ matrix.target }}-${{ hashFiles('apps/hub/kagami-orb/firmware/orb/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cross-${{ matrix.target }}-

      - name: Cross-compile (with features)
        run: cross build --target ${{ matrix.target }} --features ${{ matrix.features }} --release
        continue-on-error: true  # May not compile without hardware-specific deps

      - name: Check binary size
        run: |
          BINARY="target/${{ matrix.target }}/release/kagami-orb"
          if [ -f "$BINARY" ]; then
            SIZE=$(ls -lh "$BINARY" | awk '{print $5}')
            echo "Binary size for ${{ matrix.target }}: $SIZE"
          fi

  # ============================================================================
  # DOCUMENTATION
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint]
    defaults:
      run:
        working-directory: apps/hub/kagami-orb/firmware/orb
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            apps/hub/kagami-orb/firmware/orb/target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('apps/hub/kagami-orb/firmware/orb/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps --features desktop

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: orb-docs
          path: apps/hub/kagami-orb/firmware/orb/target/doc
          retention-days: 7

  # ============================================================================
  # SECURITY AUDIT
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint]
    defaults:
      run:
        working-directory: apps/hub/kagami-orb/firmware/orb
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Advisory, not blocking

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, cross-compile, docs, security]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Kagami Orb Firmware CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Compile | ${{ needs.cross-compile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: needs.lint.result == 'failure' || needs.test.result == 'failure'
        run: exit 1
