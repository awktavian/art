<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Command — A Smart Home Deep Dive</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/main.css">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⌘</text></svg>">
</head>
<body>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 1: THE HOOK
         Mood: Quiet drama. One command. Everything changes.
         ═══════════════════════════════════════════════════════════════════════ -->
    
    <section class="scene scene-hook">
        <div class="hook-container">
            
            <header class="hook-header">
                <span class="hook-eyebrow">A Technical Deep Dive</span>
                <h1 class="hook-title">One Command</h1>
                <p class="hook-subtitle">
                    Nine physical integrations. Ten digital services.<br>
                    One async function. Parallel execution.
                </p>
            </header>

            <div class="terminal">
                <div class="terminal-chrome">
                    <span class="terminal-dot"></span>
                    <span class="terminal-dot"></span>
                    <span class="terminal-dot"></span>
                </div>
                <div class="terminal-screen">
                    <div class="terminal-line">
                        <span class="terminal-prompt">→</span>
                        <span class="terminal-command">await controller.goodnight()</span>
                    </div>
                    <div class="terminal-output">
                        <div class="output-item" style="--delay: 0.1s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Control4: 41 lights fading</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.2s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Control4: 11 shades closing</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.3s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">August: 2 locks engaging</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.4s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Control4: Fireplace off</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.5s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Denon: Audio muting</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.6s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Mitsubishi: Night setback</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.7s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">LG TV: Screen off</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.8s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">Oelo: Outdoor lights off</span>
                            <span class="output-check">✓</span>
                        </div>
                        <div class="output-item" style="--delay: 0.9s">
                            <span class="output-icon">◐</span>
                            <span class="output-text">MantelMount: TV raising</span>
                            <span class="output-check">✓</span>
                        </div>
                    </div>
                    <div class="terminal-result">
                        <span class="result-time">✓ 9 integrations · parallel</span>
                    </div>
                </div>
            </div>

            <div class="hook-scroll">
                <span>How?</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 5v14m-7-7l7 7 7-7"/>
                </svg>
            </div>
            
        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 2: THE PROBLEM
         Mood: Chaos. Frustration. Protocol anarchy.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-problem">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">I</span>
                <h2 class="scene-title">The Problem</h2>
            </div>

            <div class="problem-content">
                <p class="problem-lead">
                    Nine physical integrations. Ten digital services. Each with its own protocol,
                    authentication dance, and assumptions about reality.
                </p>

                <div class="chaos-visualization">
                    <div class="chaos-center">
                        <span>Your Home</span>
                    </div>
                    <div class="chaos-orbit orbit-1">
                        <div class="chaos-node" style="--angle: 0deg">
                            <span class="node-name">Control4</span>
                            <span class="node-pain">24h token expiry</span>
                        </div>
                        <div class="chaos-node" style="--angle: 51deg">
                            <span class="node-name">UniFi</span>
                            <span class="node-pain">Binary WebSocket</span>
                        </div>
                        <div class="chaos-node" style="--angle: 102deg">
                            <span class="node-name">Denon</span>
                            <span class="node-pain">Telnet port 23</span>
                        </div>
                        <div class="chaos-node" style="--angle: 153deg">
                            <span class="node-name">Tesla</span>
                            <span class="node-pain">Fleet API SSE</span>
                        </div>
                        <div class="chaos-node" style="--angle: 204deg">
                            <span class="node-name">Mitsubishi</span>
                            <span class="node-pain">Kumo Cloud V3</span>
                        </div>
                        <div class="chaos-node" style="--angle: 255deg">
                            <span class="node-name">August</span>
                            <span class="node-pain">Rate limits</span>
                        </div>
                        <div class="chaos-node" style="--angle: 306deg">
                            <span class="node-name">Formlabs</span>
                            <span class="node-pain">Local REST</span>
                        </div>
                    </div>
                    <div class="chaos-orbit orbit-2">
                        <div class="chaos-node" style="--angle: 30deg">
                            <span class="node-name">Gmail</span>
                        </div>
                        <div class="chaos-node" style="--angle: 66deg">
                            <span class="node-name">Slack</span>
                        </div>
                        <div class="chaos-node" style="--angle: 102deg">
                            <span class="node-name">Calendar</span>
                        </div>
                        <div class="chaos-node" style="--angle: 138deg">
                            <span class="node-name">Linear</span>
                        </div>
                        <div class="chaos-node" style="--angle: 174deg">
                            <span class="node-name">Todoist</span>
                        </div>
                        <div class="chaos-node" style="--angle: 210deg">
                            <span class="node-name">Notion</span>
                        </div>
                        <div class="chaos-node" style="--angle: 246deg">
                            <span class="node-name">Drive</span>
                        </div>
                        <div class="chaos-node" style="--angle: 282deg">
                            <span class="node-name">Sheets</span>
                        </div>
                        <div class="chaos-node" style="--angle: 318deg">
                            <span class="node-name">Discord</span>
                        </div>
                        <div class="chaos-node" style="--angle: 354deg">
                            <span class="node-name">Twitter</span>
                        </div>
                    </div>
                    <svg class="chaos-lines" viewBox="0 0 600 600">
                        <!-- Lines drawn by JS -->
                    </svg>
                </div>

                <blockquote class="problem-quote">
                    Each vendor assumes they're the center of your universe.
                </blockquote>

                <p class="problem-text">
                    The "smart" home industry's dirty secret: nothing talks to anything else. 
                    Control4 speaks REST with proprietary tokens. UniFi uses binary WebSocket frames.
                    Denon accepts raw telnet commands on port 23. Tesla migrated to Fleet SSE.
                    Mitsubishi hides behind Kumo Cloud. Every company builds their own walled garden.
                </p>

                <p class="problem-text">
                    I wanted something different. One command to orchestrate everything. 
                    Not through a cloud service that could disappear tomorrow. 
                    Not through Home Assistant (which is excellent, but I wanted to understand 
                    every byte flowing through my network). Direct API access. Full control.
                </p>
            </div>
            
        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 3: THE ARCHITECTURE
         Mood: Clarity. Elegance emerging from chaos.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-architecture">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">II</span>
                <h2 class="scene-title">The Architecture</h2>
            </div>

            <p class="arch-lead">
                A singleton controller. Room-centric design. Every integration behind a unified interface. 
                Failure assumed. Redundancy everywhere.
            </p>

            <figure class="arch-diagram">
                <div class="arch-layer arch-top">
                    <div class="arch-box arch-controller">
                        <span class="arch-label">SmartHomeController</span>
                        <span class="arch-sublabel">singleton · 26 rooms · full authority</span>
                    </div>
                </div>

                <div class="arch-connector"></div>

                <div class="arch-layer arch-services">
                    <div class="arch-box">
                        <span class="arch-label">RoomOrchestrator</span>
                        <span class="arch-sublabel">scene activation</span>
                    </div>
                    <div class="arch-box">
                        <span class="arch-label">PresenceEngine</span>
                        <span class="arch-sublabel">Theory of Mind</span>
                    </div>
                    <div class="arch-box">
                        <span class="arch-label">FailoverManager</span>
                        <span class="arch-sublabel">circuit breakers</span>
                    </div>
                    <div class="arch-box">
                        <span class="arch-label">CBFEnforcer</span>
                        <span class="arch-sublabel">h(x) ≥ 0</span>
                    </div>
                </div>

                <div class="arch-connector"></div>

                <div class="arch-layer arch-tiers">
                    <div class="arch-tier tier-critical">
                        <span class="tier-name">Critical</span>
                        <span class="tier-desc">Locks · Security · Safety</span>
                    </div>
                    <div class="arch-tier tier-high">
                        <span class="tier-name">High</span>
                        <span class="tier-desc">Lighting · HVAC · Presence</span>
                    </div>
                    <div class="arch-tier tier-medium">
                        <span class="tier-name">Medium</span>
                        <span class="tier-desc">Audio · Video · Shades</span>
                    </div>
                    <div class="arch-tier tier-low">
                        <span class="tier-name">Low</span>
                        <span class="tier-desc">Appliances · Fabrication</span>
                    </div>
                </div>
            </figure>

            <div class="arch-insight">
                <h3>The Key Insight</h3>
                <p>
                    Every integration will fail. The question isn't <em>if</em>, it's <em>when</em>. 
                    So the system assumes failure as the default state and builds redundancy at every layer.
                </p>
                <p>
                    If Control4 goes down, lighting degrades to direct Lutron LEAP. 
                    If UniFi fails, presence falls back to Tesla geofencing, then August door sensors. 
                    There's always another path.
                </p>
            </div>

            <figure class="code-figure">
                <figcaption>failover_manager.py</figcaption>
                <pre><code>FAILOVER_ROUTES = {
    <span class="code-string">"presence"</span>: [
        <span class="code-string">"unifi"</span>,        <span class="code-comment"># WiFi + cameras (primary)</span>
        <span class="code-string">"tesla"</span>,        <span class="code-comment"># Vehicle geofencing</span>
        <span class="code-string">"august"</span>,       <span class="code-comment"># Door activity</span>
    ],
    <span class="code-string">"lighting"</span>: [
        <span class="code-string">"control4"</span>,     <span class="code-comment"># Director API</span>
        <span class="code-string">"lutron_leap"</span>, <span class="code-comment"># Direct LEAP fallback</span>
    ],
    <span class="code-string">"climate"</span>: [
        <span class="code-string">"mitsubishi"</span>,  <span class="code-comment"># Kumo Cloud V3</span>
        <span class="code-string">"control4"</span>,     <span class="code-comment"># Thermostat backup</span>
    ],
}</code></pre>
            </figure>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 4: CONTROL4 DEEP DIVE
         Mood: Getting hands dirty. The heart of the system.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">III</span>
                <h2 class="scene-title">Control4</h2>
                <p class="scene-subtitle">The heart of the system</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">41</span>
                    <span class="stat-unit">lights</span>
                </div>
                <div class="stat">
                    <span class="stat-value">11</span>
                    <span class="stat-unit">shades</span>
                </div>
                <div class="stat">
                    <span class="stat-value">26</span>
                    <span class="stat-unit">audio zones</span>
                </div>
                <div class="stat">
                    <span class="stat-value">2</span>
                    <span class="stat-unit">locks</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>The Challenge</h3>
                <p>
                    Control4 is professional-grade home automation. They really don't want 
                    you accessing it directly. The official path: mobile app → their cloud → 
                    your local Director. I wanted direct local control. No cloud dependency. 
                    Sub-100ms response times.
                </p>

                <h3>The Token Dance</h3>
                <p>
                    The Director exposes a REST API, but only with a valid bearer token. 
                    Getting that token requires a three-step authentication dance through 
                    their cloud. The token expires every 24 hours.
                </p>

                <figure class="code-figure">
                    <figcaption>control4.py</figcaption>
                    <pre><code><span class="code-keyword">async def</span> <span class="code-function">_authenticate</span>(self) -> Control4Token:
    <span class="code-comment"># Step 1: Cloud authentication</span>
    account_token = <span class="code-keyword">await</span> self._cloud_auth()
    
    <span class="code-comment"># Step 2: Controller authorization</span>
    controller = <span class="code-keyword">await</span> self._get_controllers(account_token)
    
    <span class="code-comment"># Step 3: Director token exchange</span>
    director_token = <span class="code-keyword">await</span> self._get_director_token(
        account_token,
        controller[<span class="code-string">"controllerCommonName"</span>]
    )
    
    <span class="code-comment"># Valid for ~24 hours</span>
    <span class="code-keyword">return</span> Control4Token(
        director_token=director_token,
        expires_at=time.time() + <span class="code-number">86400</span>
    )</code></pre>
                </figure>

                <h3>Device ID Archaeology</h3>
                <p>
                    Control4 uses internal integer IDs that aren't documented anywhere. 
                    Light 239 is the living room cans. Shade 66 is the primary bedroom north window. 
                    Room 57 is the Living Room. I had to enumerate all items, categorize by type, 
                    and manually map them to rooms. The <code>_items</code> dictionary now contains 
                    200+ device mappings built from trial and error.
                </p>

                <h3>Real-Time WebSocket</h3>
                <p>
                    Beyond REST, Control4 offers WebSocket for real-time events. Device state changes,
                    button presses, security events—all arrive within milliseconds. The connection
                    requires the same bearer token and periodic keep-alives.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 5: UNIFI DEEP DIVE
         Mood: Reverse engineering. Binary protocols.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration scene-alt">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">IV</span>
                <h2 class="scene-title">UniFi Protect</h2>
                <p class="scene-subtitle">Real-time presence through binary WebSocket</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">4</span>
                    <span class="stat-unit">AI cameras</span>
                </div>
                <div class="stat">
                    <span class="stat-value">UDM</span>
                    <span class="stat-unit">Pro Max</span>
                </div>
                <div class="stat">
                    <span class="stat-value">22TB</span>
                    <span class="stat-unit">NVR storage</span>
                </div>
                <div class="stat">
                    <span class="stat-value">WiFi</span>
                    <span class="stat-unit">presence</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>The Challenge</h3>
                <p>
                    UniFi Protect's WebSocket API uses a custom binary protocol. 
                    The documentation doesn't exist. I had to reverse-engineer the frame 
                    format by watching network traffic.
                </p>

                <figure class="protocol-figure">
                    <div class="protocol-frame">
                        <div class="frame-section">
                            <span class="frame-label">Header</span>
                            <span class="frame-size">8 bytes</span>
                        </div>
                        <div class="frame-fields">
                            <span>packet_type</span>
                            <span>payload_format</span>
                            <span>deflated</span>
                            <span>payload_size</span>
                        </div>
                    </div>
                    <span class="protocol-arrow">→</span>
                    <div class="protocol-frame">
                        <div class="frame-section">
                            <span class="frame-label">Action</span>
                        </div>
                        <div class="frame-fields">
                            <span>action</span>
                            <span>modelKey</span>
                            <span>id</span>
                        </div>
                    </div>
                    <span class="protocol-arrow">→</span>
                    <div class="protocol-frame">
                        <div class="frame-section">
                            <span class="frame-label">Data</span>
                        </div>
                        <div class="frame-fields">
                            <span>JSON payload</span>
                        </div>
                    </div>
                </figure>

                <figure class="code-figure">
                    <figcaption>unifi.py</figcaption>
                    <pre><code><span class="code-keyword">def</span> <span class="code-function">_parse_ws_frame</span>(self, data: bytes) -> dict:
    <span class="code-comment"># Unpack 8-byte header</span>
    packet_type = data[<span class="code-number">0</span>]
    payload_format = data[<span class="code-number">1</span>]
    deflated = data[<span class="code-number">2</span>]
    payload_size = struct.unpack(<span class="code-string">"&gt;I"</span>, data[<span class="code-number">4</span>:<span class="code-number">8</span>])[<span class="code-number">0</span>]
    
    payload = data[<span class="code-number">8</span>:<span class="code-number">8</span> + payload_size]
    
    <span class="code-keyword">if</span> deflated:
        payload = zlib.decompress(payload)
    
    <span class="code-keyword">return</span> json.loads(payload)</code></pre>
                </figure>

                <h3>Local Admin Discovery</h3>
                <p>
                    UniFi's 2FA flow makes automation painful. After days of frustration, 
                    I discovered you can create a local-only admin account on the UDM Pro 
                    that bypasses 2FA entirely. This isn't documented anywhere obvious.
                    The trick: Settings → Admins → Add Admin → Local Access Only.
                </p>

                <h3>Motion Events</h3>
                <p>
                    The AI cameras detect motion, people, vehicles, and packages. Events arrive 
                    via WebSocket within 50ms. The system can react to motion as it happens,
                    not seconds later through polling.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 6: DENON DEEP DIVE
         Mood: Old-school protocols. Telnet in 2025.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">V</span>
                <h2 class="scene-title">Denon AVR</h2>
                <p class="scene-subtitle">Home theater via telnet and HEOS</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">15.4</span>
                    <span class="stat-unit">channels</span>
                </div>
                <div class="stat">
                    <span class="stat-value">A10H</span>
                    <span class="stat-unit">flagship</span>
                </div>
                <div class="stat">
                    <span class="stat-value">Atmos</span>
                    <span class="stat-unit">5.2.4</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>Two Protocols</h3>
                <p>
                    Denon offers two integration paths: raw telnet commands on port 23, and the 
                    HEOS WebSocket API for real-time events. I use both. Telnet for commands
                    (it's faster), HEOS for state notifications.
                </p>

                <figure class="code-figure">
                    <figcaption>denon.py — Telnet Control</figcaption>
                    <pre><code><span class="code-keyword">async def</span> <span class="code-function">connect</span>(self, max_retries: int = <span class="code-number">3</span>) -> bool:
    <span class="code-comment"># Denon uses raw TCP on port 23</span>
    <span class="code-keyword">for</span> attempt <span class="code-keyword">in</span> range(max_retries):
        <span class="code-keyword">try</span>:
            self._reader, self._writer = <span class="code-keyword">await</span> asyncio.wait_for(
                asyncio.open_connection(self._host, <span class="code-number">23</span>),
                timeout=<span class="code-number">20.0</span>
            )
            <span class="code-keyword">return</span> <span class="code-keyword">True</span>
        <span class="code-keyword">except</span> asyncio.TimeoutError:
            <span class="code-keyword">await</span> asyncio.sleep(<span class="code-number">2</span> ** attempt)
    <span class="code-keyword">return</span> <span class="code-keyword">False</span>

<span class="code-keyword">async def</span> <span class="code-function">send_command</span>(self, cmd: str) -> str:
    <span class="code-comment"># Commands are plain text, CR terminated</span>
    self._writer.write(f<span class="code-string">"{cmd}\r"</span>.encode())
    <span class="code-keyword">await</span> self._writer.drain()
    response = <span class="code-keyword">await</span> self._reader.readline()
    <span class="code-keyword">return</span> response.decode().strip()</code></pre>
                </figure>

                <h3>Input Source Archaeology</h3>
                <p>
                    The API accepts input names like "MPLAY" and "SAT/CBL". 
                    The UI shows "Apple TV" and "Cable". There's no mapping documentation. 
                    I literally tried every combination of input names and recorded which ones worked.
                </p>

                <figure class="code-figure">
                    <figcaption>Input Mapping</figcaption>
                    <pre><code>INPUT_MAP = {
    <span class="code-string">"Apple TV"</span>:    <span class="code-string">"MPLAY"</span>,     <span class="code-comment"># Media Player</span>
    <span class="code-string">"Cable"</span>:       <span class="code-string">"SAT/CBL"</span>,   <span class="code-comment"># Satellite/Cable</span>
    <span class="code-string">"Blu-ray"</span>:     <span class="code-string">"BD"</span>,        <span class="code-comment"># Blu-ray Disc</span>
    <span class="code-string">"Game"</span>:        <span class="code-string">"GAME"</span>,      <span class="code-comment"># Game Console</span>
    <span class="code-string">"Turntable"</span>:   <span class="code-string">"PHONO"</span>,     <span class="code-comment"># Phono Input</span>
}</code></pre>
                </figure>

                <h3>HEOS Real-Time Events</h3>
                <p>
                    HEOS provides WebSocket notifications for volume changes, input switches, and 
                    playback state. Events arrive within 200ms—fast enough for synchronized UI updates.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 7: TESLA DEEP DIVE
         Mood: API migration pain. The SSE revelation.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration scene-alt">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">VI</span>
                <h2 class="scene-title">Tesla Fleet</h2>
                <p class="scene-subtitle">Vehicle presence via Server-Sent Events</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">SSE</span>
                    <span class="stat-unit">streaming</span>
                </div>
                <div class="stat">
                    <span class="stat-value">~500ms</span>
                    <span class="stat-unit">latency</span>
                </div>
                <div class="stat">
                    <span class="stat-value">Geofence</span>
                    <span class="stat-unit">presence</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>The Migration</h3>
                <p>
                    My working Tesla integration suddenly stopped. Tesla had deprecated 
                    the Vehicle API. The new Fleet API requires registering as a "partner," 
                    which means hosting a public key at a specific URL path on a verified domain. 
                    For a personal project.
                </p>

                <p>
                    The reward: Server-Sent Events (SSE) streaming. Instead of polling every 30 seconds,
                    location updates arrive in real-time as the car moves. Geofence detection 
                    triggers within 500ms of crossing the boundary.
                </p>

                <figure class="code-figure">
                    <figcaption>tesla.py — SSE Streaming</figcaption>
                    <pre><code><span class="code-keyword">async def</span> <span class="code-function">stream_telemetry</span>(self):
    <span class="code-comment"># Fleet API uses Server-Sent Events</span>
    <span class="code-keyword">async with</span> self._session.get(
        f<span class="code-string">"{FLEET_URL}/vehicles/{self._vin}/telemetry_stream"</span>,
        headers={<span class="code-string">"Authorization"</span>: f<span class="code-string">"Bearer {self._token}"</span>}
    ) <span class="code-keyword">as</span> response:
        <span class="code-keyword">async for</span> line <span class="code-keyword">in</span> response.content:
            <span class="code-keyword">if</span> line.startswith(b<span class="code-string">"data: "</span>):
                data = json.loads(line[<span class="code-number">6</span>:])
                <span class="code-keyword">await</span> self._handle_telemetry(data)</code></pre>
                </figure>

                <h3>Geofence Presence</h3>
                <p>
                    When the car crosses within 200m of home, the system triggers arrival preparation.
                    Lights warm up, locks prepare to disengage, HVAC adjusts. By the time you park,
                    the house is ready.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 8: MITSUBISHI DEEP DIVE
         Mood: Cloud APIs. Zone control.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">VII</span>
                <h2 class="scene-title">Mitsubishi HVAC</h2>
                <p class="scene-subtitle">Five-zone climate via Kumo Cloud</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">5</span>
                    <span class="stat-unit">zones</span>
                </div>
                <div class="stat">
                    <span class="stat-value">Kumo</span>
                    <span class="stat-unit">Cloud V3</span>
                </div>
                <div class="stat">
                    <span class="stat-value">60-85°F</span>
                    <span class="stat-unit">safe range</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>The Challenge</h3>
                <p>
                    Mitsubishi's mini-splits are connected through Kumo Cloud. Unlike most IoT,
                    they actually expose a reasonable API. The V3 API provides device discovery,
                    state polling, and command execution with proper error handling.
                </p>

                <figure class="code-figure">
                    <figcaption>mitsubishi.py</figcaption>
                    <pre><code><span class="code-keyword">async def</span> <span class="code-function">set_temperature</span>(
    self,
    zone: str,
    temp_f: float,
    mode: str = <span class="code-string">"auto"</span>
) -> bool:
    <span class="code-comment"># Kumo Cloud V3 API</span>
    device = self._zones.get(zone)
    <span class="code-keyword">if not</span> device:
        <span class="code-keyword">return</span> <span class="code-keyword">False</span>
    
    <span class="code-comment"># CBF safety bounds: 60-85°F</span>
    temp_f = max(<span class="code-number">60</span>, min(<span class="code-number">85</span>, temp_f))
    
    <span class="code-keyword">await</span> self._api.set_device(
        device[<span class="code-string">"serial"</span>],
        {<span class="code-string">"spCool"</span>: temp_f, <span class="code-string">"mode"</span>: mode}
    )
    <span class="code-keyword">return</span> <span class="code-keyword">True</span></code></pre>
                </figure>

                <h3>Zone Coordination</h3>
                <p>
                    Each room can have its own temperature. The office warms before work hours.
                    The bedroom cools before sleep. The system learns your patterns and pre-conditions
                    zones before you arrive.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 9: WORKSHOP DEEP DIVE
         Mood: Maker dreams. Local APIs.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-integration scene-alt">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">VIII</span>
                <h2 class="scene-title">Workshop</h2>
                <p class="scene-subtitle">Fabrication monitoring and control</p>
            </div>

            <div class="integration-stats">
                <div class="stat">
                    <span class="stat-value">Form 4</span>
                    <span class="stat-unit">3D printer</span>
                </div>
                <div class="stat">
                    <span class="stat-value">Local</span>
                    <span class="stat-unit">REST API</span>
                </div>
                <div class="stat">
                    <span class="stat-value">45W</span>
                    <span class="stat-unit">Glowforge laser</span>
                </div>
            </div>

            <div class="integration-content">
                <h3>Formlabs Form 4</h3>
                <p>
                    Unlike most IoT devices, Formlabs exposes a local REST API on your network.
                    Print status, job queue, material levels—all accessible without cloud dependency.
                    When a print completes, the house announces it through the nearest speaker.
                </p>

                <figure class="code-figure">
                    <figcaption>formlabs.py</figcaption>
                    <pre><code><span class="code-keyword">async def</span> <span class="code-function">get_printer_status</span>(self) -> PrinterStatus:
    <span class="code-comment"># Local API on port 80</span>
    <span class="code-keyword">async with</span> self._session.get(
        f<span class="code-string">"http://{self._host}/api/v1/status"</span>
    ) <span class="code-keyword">as</span> response:
        data = <span class="code-keyword">await</span> response.json()
        <span class="code-keyword">return</span> PrinterStatus(
            state=data[<span class="code-string">"printer_state"</span>],
            job_name=data.get(<span class="code-string">"current_job"</span>, {}).get(<span class="code-string">"name"</span>),
            progress=data.get(<span class="code-string">"print_progress"</span>, <span class="code-number">0</span>),
            time_remaining=data.get(<span class="code-string">"time_remaining_sec"</span>)
        )</code></pre>
                </figure>

                <h3>Glowforge (Limited)</h3>
                <p>
                    The Glowforge Pro is cloud-only by design. I can detect its presence on the network
                    via mDNS and monitor online/offline status, but actual control requires their web app.
                    This is on the "Up Next" list for deeper integration if they ever open the API.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 10: THEORY OF MIND
         Mood: Intelligence. The system learns.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-mind">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">IX</span>
                <h2 class="scene-title">Theory of Mind</h2>
                <p class="scene-subtitle">The system doesn't just see. It understands.</p>
            </div>

            <div class="mind-progression">
                <div class="mind-stage">
                    <span class="mind-number">1</span>
                    <span class="mind-question">Where?</span>
                    <p>Sensor fusion: WiFi, cameras, motion, car</p>
                </div>
                <div class="mind-arrow">→</div>
                <div class="mind-stage">
                    <span class="mind-number">2</span>
                    <span class="mind-question">What?</span>
                    <p>Activity inference from location + time</p>
                </div>
                <div class="mind-arrow">→</div>
                <div class="mind-stage">
                    <span class="mind-number">3</span>
                    <span class="mind-question">Why?</span>
                    <p>Intent prediction from learned patterns</p>
                </div>
                <div class="mind-arrow">→</div>
                <div class="mind-stage">
                    <span class="mind-number">4</span>
                    <span class="mind-question">Next?</span>
                    <p>Anticipate needs before you know them</p>
                </div>
            </div>

            <div class="mind-content">
                <h3>Pattern Learning with Exponential Moving Average</h3>
                <p>
                    The <code>PatternLearner</code> divides each day into 30-minute slots, 
                    separately tracking weekdays and weekends. Every observation updates 
                    probabilities using an exponential moving average—recent behavior 
                    matters more than old habits, but stable patterns persist.
                </p>

                <figure class="code-figure">
                    <figcaption>presence.py — observe_room</figcaption>
                    <pre><code><span class="code-keyword">def</span> <span class="code-function">observe_room</span>(self, room_name: str, timestamp: float):
    slot = TimeSlot.from_timestamp(timestamp)
    pattern = self._patterns[slot]
    
    <span class="code-comment"># EMA: decay old observations, boost current</span>
    alpha = self.learning_rate  <span class="code-comment"># 0.1</span>
    <span class="code-keyword">for</span> room <span class="code-keyword">in</span> pattern.room_probabilities:
        pattern.room_probabilities[room] *= (1 - alpha)
    
    current = pattern.room_probabilities.get(room_name, 0.0)
    pattern.room_probabilities[room_name] = current + alpha * (1 - current)</code></pre>
                </figure>

                <h3>Transition Learning</h3>
                <p>
                    Beyond "where are you now," the system learns "where do you go next." 
                    When you walk from the kitchen to the office every weekday at 9am, 
                    that transition gets reinforced. After a few weeks, it knows the 
                    morning sequence: bedroom → bathroom → kitchen → office.
                </p>

                <figure class="code-figure">
                    <figcaption>presence.py — predict_next_room</figcaption>
                    <pre><code><span class="code-keyword">def</span> <span class="code-function">predict_next_room</span>(self, current_room: str) -> tuple[str, float]:
    slot = TimeSlot.current()
    transitions = self._patterns[slot].transitions[current_room]
    
    <span class="code-keyword">if not</span> transitions:
        <span class="code-keyword">return</span> None
    
    best_room = max(transitions.keys(), key=<span class="code-keyword">lambda</span> r: transitions[r])
    <span class="code-keyword">return</span> (best_room, transitions[best_room])</code></pre>
                </figure>

                <h3>Intent Prediction: Multi-Signal Fusion</h3>
                <p>
                    The <code>IntentPredictor</code> combines four weighted signals—time of day, 
                    current location, historical patterns, and device states—to predict 
                    what you're about to do. Eight Sleep says you just woke up. Denon is on. 
                    Your car just arrived. Each signal adds evidence.
                </p>

                <figure class="signal-fusion">
                    <div class="signal-row">
                        <span class="signal-name">Time</span>
                        <span class="signal-weight">30%</span>
                        <span class="signal-desc">Morning routine vs evening wind-down</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Location</span>
                        <span class="signal-weight">25%</span>
                        <span class="signal-desc">Which room you're in right now</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Pattern</span>
                        <span class="signal-weight">25%</span>
                        <span class="signal-desc">What you usually do at this time slot</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-name">Device</span>
                        <span class="signal-weight">20%</span>
                        <span class="signal-desc">Eight Sleep awake, Denon on, car home</span>
                    </div>
                </figure>

                <h3>Activity Context</h3>
                <p>
                    Room + time + duration maps to activity. The system doesn't need explicit 
                    "I'm cooking" declarations — it infers from behavior.
                </p>

                <figure class="context-table">
                    <div class="context-row context-header">
                        <span>Room</span>
                        <span>Time</span>
                        <span>Duration</span>
                        <span>Activity</span>
                    </div>
                    <div class="context-row">
                        <span>Kitchen</span>
                        <span>6–9am</span>
                        <span>15–30min</span>
                        <span class="context-activity">COOKING</span>
                    </div>
                    <div class="context-row">
                        <span>Office</span>
                        <span>9am–5pm</span>
                        <span>&gt; 30min</span>
                        <span class="context-activity">WORKING</span>
                    </div>
                    <div class="context-row">
                        <span>Living Room</span>
                        <span>7–11pm</span>
                        <span>&gt; 20min</span>
                        <span class="context-activity">RELAXING</span>
                    </div>
                    <div class="context-row">
                        <span>Primary Bed</span>
                        <span>10pm–7am</span>
                        <span>&gt; 15min</span>
                        <span class="context-activity">SLEEPING</span>
                    </div>
                </figure>

                <h3>Preference Learning</h3>
                <p>
                    When you manually adjust the lights after the system sets them, 
                    the adjustment gets recorded against your current room and activity.
                    Over time, "Office + WORKING" learns your preferred brightness. 
                    The system stops guessing and starts knowing.
                </p>

                <figure class="code-figure">
                    <figcaption>presence.py — learn_preference</figcaption>
                    <pre><code><span class="code-keyword">def</span> <span class="code-function">learn_preference</span>(self, room: str, activity: ActivityContext, 
                        setting: str, value: float):
    prefs = self._preferences[room][activity.value]
    current = prefs.get(setting, value)
    
    <span class="code-comment"># Blend toward new preference</span>
    prefs[setting] = current * (1 - alpha) + value * alpha</code></pre>
                </figure>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 11: SITUATION AWARENESS
         Mood: Layers. Hierarchy. Prediction.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-awareness">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">X</span>
                <h2 class="scene-title">Situation Awareness</h2>
                <p class="scene-subtitle">Four layers of predictive understanding</p>
            </div>

            <div class="awareness-layers">
                <div class="awareness-layer">
                    <span class="layer-name">Perception</span>
                    <span class="layer-desc">Raw sensor fusion from all sources</span>
                </div>
                <div class="awareness-arrow">↓</div>
                <div class="awareness-layer">
                    <span class="layer-name">Comprehension</span>
                    <span class="layer-desc">Pattern matching and activity inference</span>
                </div>
                <div class="awareness-arrow">↓</div>
                <div class="awareness-layer">
                    <span class="layer-name">Projection</span>
                    <span class="layer-desc">What will likely happen next</span>
                </div>
                <div class="awareness-arrow">↓</div>
                <div class="awareness-layer">
                    <span class="layer-name">Anticipation</span>
                    <span class="layer-desc">Pre-position resources for predicted needs</span>
                </div>
            </div>

            <div class="awareness-content">
                <h3>The Wakefulness Manager</h3>
                <p>
                    The system has its own wakefulness—a single state that propagates to every 
                    subsystem: polling rates, autonomy decisions, and alert thresholds.
                </p>

                <figure class="wakefulness-table">
                    <div class="wake-row wake-header">
                        <span>Level</span>
                        <span>Poll Rate</span>
                        <span>Autonomy</span>
                        <span>Alert Threshold</span>
                    </div>
                    <div class="wake-row">
                        <span class="wake-level">DORMANT</span>
                        <span>10× slower</span>
                        <span>Off</span>
                        <span>Critical only</span>
                    </div>
                    <div class="wake-row">
                        <span class="wake-level">DROWSY</span>
                        <span>3× slower</span>
                        <span>Off</span>
                        <span>High+</span>
                    </div>
                    <div class="wake-row">
                        <span class="wake-level">ALERT</span>
                        <span>Normal</span>
                        <span>Full</span>
                        <span>Normal+</span>
                    </div>
                    <div class="wake-row">
                        <span class="wake-level">FOCUSED</span>
                        <span>2× slower</span>
                        <span>Full</span>
                        <span>High+ only</span>
                    </div>
                    <div class="wake-row">
                        <span class="wake-level">HYPER</span>
                        <span>2× faster</span>
                        <span>Full</span>
                        <span>All alerts</span>
                    </div>
                </figure>

                <h3>Per-Sense Overrides</h3>
                <p>
                    Not all senses slow down equally. During FOCUSED mode, Gmail polls 5× slower 
                    and Discord 10× slower—but calendar stays fast. Security and locks 
                    always poll at normal speed, regardless of wakefulness.
                </p>

                <figure class="code-figure">
                    <figcaption>wakefulness.py — FOCUSED mode</figcaption>
                    <pre><code>WakefulnessLevel.FOCUSED: WakefulnessConfig(
    poll_multiplier=<span class="code-number">2.0</span>,     <span class="code-comment"># Slower polling</span>
    autonomy_enabled=<span class="code-keyword">True</span>,   <span class="code-comment"># But autonomy continues</span>
    alert_min_priority=<span class="code-number">2</span>,    <span class="code-comment"># Only high priority</span>
    sense_overrides={
        <span class="code-string">"gmail"</span>: <span class="code-number">5.0</span>,       <span class="code-comment"># Much slower</span>
        <span class="code-string">"discord"</span>: <span class="code-number">10.0</span>,    <span class="code-comment"># Almost no polling</span>
        <span class="code-string">"calendar"</span>: <span class="code-number">1.0</span>,    <span class="code-comment"># Watch calendar</span>
    },
)</code></pre>
                </figure>

                <h3>Adaptive Polling Formula</h3>
                <p>
                    The final poll interval stacks five multipliers. At 2am when you're sleeping 
                    and away, email might poll once every 30 minutes instead of every minute.
                </p>

                <figure class="formula-figure">
                    <code>interval = base × wake × activity × presence × time</code>
                    <span class="formula-constraint">Clamped to 0.25× – 10× of base</span>
                </figure>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 12: CROSS-DOMAIN BRIDGE
         Mood: Digital meets physical. Magic happens.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-bridge">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XI</span>
                <h2 class="scene-title">Cross-Domain Bridge</h2>
                <p class="scene-subtitle">When digital events trigger physical responses</p>
            </div>

            <div class="bridge-diagram">
                <div class="bridge-side bridge-digital">
                    <span class="bridge-label">Digital (Composio)</span>
                    <div class="bridge-items">
                        <span>Gmail</span>
                        <span>Slack</span>
                        <span>Calendar</span>
                        <span>Linear</span>
                        <span>+6 more</span>
                    </div>
                </div>
                <div class="bridge-center">
                    <span class="bridge-arrow">→</span>
                    <span class="bridge-text">Triggers</span>
                    <span class="bridge-arrow">→</span>
                </div>
                <div class="bridge-side bridge-physical">
                    <span class="bridge-label">Physical (SmartHome)</span>
                    <div class="bridge-items">
                        <span>Lights</span>
                        <span>Audio</span>
                        <span>HVAC</span>
                        <span>Shades</span>
                        <span>+more</span>
                    </div>
                </div>
            </div>

            <div class="bridge-content">
                <h3>Trigger Architecture</h3>
                <p>
                    Each <code>CrossDomainTrigger</code> binds a condition function to an action.
                    When a sense polls new data, the bridge evaluates all triggers. Those that 
                    match and haven't fired within their cooldown window execute their action.
                </p>

                <figure class="code-figure">
                    <figcaption>cross_domain_bridge.py — Trigger definition</figcaption>
                    <pre><code>CrossDomainTrigger(
    name=<span class="code-string">"urgent_email"</span>,
    source=<span class="code-string">"gmail"</span>,
    condition=<span class="code-keyword">lambda</span> d: d.get(<span class="code-string">"is_urgent"</span>),
    action=announce_to_occupied_room,
    cooldown=<span class="code-number">300.0</span>,  <span class="code-comment"># 5 minutes</span>
)</code></pre>
                </figure>

                <h3>Ten Active Triggers</h3>
                <figure class="triggers-list">
                    <div class="trigger-row">
                        <span class="trigger-event">Urgent email arrives</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Announce via occupied room speaker</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Meeting in 15 minutes</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Office lights optimize, shades adjust</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Sleep detected</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Trigger goodnight scene</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Vehicle arriving (ETA &lt;5min)</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Trigger welcome_home</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Hot/sunny weather</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Close south-facing shades</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">PR merged on GitHub</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Celebration announcement</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Rain starting</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Close shades, announce</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Cold weather alert</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">HVAC comfort suggestion</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Sunset approaching</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Prepare evening lighting</span>
                    </div>
                    <div class="trigger-row">
                        <span class="trigger-event">Snow detected</span>
                        <span class="trigger-arrow">→</span>
                        <span class="trigger-action">Safety announcement</span>
                    </div>
                </figure>

                <h3>Cooldown and Dedup</h3>
                <p>
                    Each trigger tracks <code>last_triggered</code> and won't fire again until its 
                    cooldown expires. Email announcements also track message IDs to prevent
                    duplicate reads of the same urgent message.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 13: PERFORMANCE
         Mood: Speed. Precision. The numbers matter.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-performance">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XII</span>
                <h2 class="scene-title">Performance</h2>
                <p class="scene-subtitle">Speed through parallelism and resilience</p>
            </div>

            <div class="perf-content">
                <h3>Parallel Execution</h3>
                <p>
                    Scene activation doesn't wait for each device sequentially. 
                    Independent operations run in parallel via <code>asyncio.gather()</code>.
                    A scene touching four integrations completes in the time of the slowest, 
                    not the sum of all.
                </p>

                <figure class="timeline-figure">
                    <div class="timeline-track">
                        <div class="timeline-row">
                            <span class="timeline-label">Control4</span>
                            <div class="timeline-bar" style="--start: 0; --width: 70"></div>
                        </div>
                        <div class="timeline-row">
                            <span class="timeline-label">Mitsubishi</span>
                            <div class="timeline-bar" style="--start: 0; --width: 45"></div>
                        </div>
                        <div class="timeline-row">
                            <span class="timeline-label">Denon</span>
                            <div class="timeline-bar" style="--start: 5; --width: 35"></div>
                        </div>
                        <div class="timeline-row">
                            <span class="timeline-label">August</span>
                            <div class="timeline-bar" style="--start: 10; --width: 60"></div>
                        </div>
                    </div>
                    <div class="timeline-scale">
                        <span>0ms</span>
                        <span>250ms</span>
                        <span>500ms</span>
                        <span>750ms</span>
                        <span>1000ms</span>
                    </div>
                </figure>

                <h3>Circuit Breakers by Tier</h3>
                <p>
                    Each integration has a circuit breaker configured by criticality tier. 
                    Critical systems (locks, security) get more retries before tripping. 
                    Once tripped, the breaker stays open—one failing integration 
                    can't block the entire system.
                </p>

                <figure class="circuit-table">
                    <div class="circuit-row circuit-header">
                        <span>Integration</span>
                        <span>Tier</span>
                        <span>Threshold</span>
                        <span>Check Interval</span>
                    </div>
                    <div class="circuit-row">
                        <span>Control4</span>
                        <span class="tier-critical">CRITICAL</span>
                        <span>5 failures</span>
                        <span>30s</span>
                    </div>
                    <div class="circuit-row">
                        <span>UniFi</span>
                        <span class="tier-critical">CRITICAL</span>
                        <span>5 failures</span>
                        <span>60s</span>
                    </div>
                    <div class="circuit-row">
                        <span>Denon</span>
                        <span class="tier-important">IMPORTANT</span>
                        <span>3 failures</span>
                        <span>120s</span>
                    </div>
                    <div class="circuit-row">
                        <span>Eight Sleep</span>
                        <span class="tier-essential">ESSENTIAL</span>
                        <span>3 failures</span>
                        <span>300s</span>
                    </div>
                </figure>

                <h3>Failover Routes</h3>
                <p>
                    If Control4 goes down, lighting degrades to direct Lutron LEAP. 
                    If UniFi fails, presence falls back to Tesla geofencing, then August door sensors. 
                    There's always another path.
                </p>

                <figure class="code-figure">
                    <figcaption>failover_manager.py</figcaption>
                    <pre><code>FAILOVER_ROUTES = {
    <span class="code-string">"presence"</span>: [<span class="code-string">"unifi"</span>, <span class="code-string">"tesla"</span>, <span class="code-string">"august"</span>],
    <span class="code-string">"lighting"</span>: [<span class="code-string">"control4"</span>, <span class="code-string">"lutron_leap"</span>],
    <span class="code-string">"climate"</span>:  [<span class="code-string">"mitsubishi"</span>, <span class="code-string">"control4"</span>],
}</code></pre>
                </figure>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 14: SAFETY
         Mood: Responsibility. The invariant that protects everything.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-safety">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XIII</span>
                <h2 class="scene-title">Safety</h2>
            </div>

            <div class="safety-hero">
                <div class="safety-formula">h(x) ≥ 0</div>
                <p class="safety-meaning">Always.</p>
            </div>

            <div class="safety-content">
                <p>
                    Some actions have consequences. The fireplace can start a fire. 
                    The TV mount can crush something. The locks have security implications. 
                    Every physical action passes through a Control Barrier Function (CBF) enforcer. 
                    If h(x) drops below zero, the action is blocked.
                </p>

                <div class="safety-rules">
                    <div class="safety-rule">
                        <span class="rule-icon">🔥</span>
                        <div class="rule-content">
                            <span class="rule-name">Fireplace</span>
                            <span class="rule-constraint">Auto-off after 4 hours</span>
                        </div>
                    </div>
                    <div class="safety-rule">
                        <span class="rule-icon">📺</span>
                        <div class="rule-content">
                            <span class="rule-name">TV Mount</span>
                            <span class="rule-constraint">Preset positions only (never arbitrary)</span>
                        </div>
                    </div>
                    <div class="safety-rule">
                        <span class="rule-icon">🔓</span>
                        <div class="rule-content">
                            <span class="rule-name">Unlock</span>
                            <span class="rule-constraint">Requires presence confirmation</span>
                        </div>
                    </div>
                    <div class="safety-rule">
                        <span class="rule-icon">❄️</span>
                        <div class="rule-content">
                            <span class="rule-name">HVAC</span>
                            <span class="rule-constraint">60–85°F range enforced</span>
                        </div>
                    </div>
                    <div class="safety-rule">
                        <span class="rule-icon">🔒</span>
                        <div class="rule-content">
                            <span class="rule-name">Security</span>
                            <span class="rule-constraint">Cannot disarm without presence</span>
                        </div>
                    </div>
                </div>

                <figure class="code-figure">
                    <figcaption>universal_cbf_enforcer.py</figcaption>
                    <pre><code><span class="code-keyword">def</span> <span class="code-function">check_action</span>(self, action: Action, state: HomeState) -> bool:
    <span class="code-comment"># Compute barrier function value</span>
    h_x = self._compute_barrier(action, state)
    
    <span class="code-keyword">if</span> h_x < <span class="code-number">0</span>:
        logger.warning(f<span class="code-string">"CBF violation: {action} blocked (h={h_x:.3f})"</span>)
        <span class="code-keyword">return</span> <span class="code-keyword">False</span>
    
    <span class="code-keyword">return</span> <span class="code-keyword">True</span></code></pre>
                </figure>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 15: REAL-TIME EVENTS
         Mood: WebSockets. Speed targets. Latency budgets.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-realtime">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XIV</span>
                <h2 class="scene-title">Real-Time Events</h2>
                <p class="scene-subtitle">WebSocket, SSE, and strategic polling</p>
            </div>

            <div class="realtime-grid">
                <div class="realtime-source">
                    <span class="source-name">UniFi WebSocket</span>
                    <span class="source-latency">&lt; 50ms</span>
                    <span class="source-type">Binary frames</span>
                </div>
                <div class="realtime-source">
                    <span class="source-name">Control4 WebSocket</span>
                    <span class="source-latency">&lt; 100ms</span>
                    <span class="source-type">JSON events</span>
                </div>
                <div class="realtime-source">
                    <span class="source-name">Denon HEOS</span>
                    <span class="source-latency">&lt; 200ms</span>
                    <span class="source-type">WebSocket</span>
                </div>
                <div class="realtime-source">
                    <span class="source-name">Tesla Fleet</span>
                    <span class="source-latency">~500ms</span>
                    <span class="source-type">SSE streaming</span>
                </div>
            </div>

            <div class="realtime-content">
                <h3>Event-Driven Architecture</h3>
                <p>
                    Four sources push events as they happen. Motion detection arrives in 50ms.
                    The system can react before you've finished walking through a room.
                </p>

                <figure class="event-flow">
                    <div class="event-sources">
                        <span>UniFi</span>
                        <span>Control4</span>
                        <span>Denon</span>
                        <span>Tesla</span>
                    </div>
                    <div class="event-arrow">↓</div>
                    <div class="event-bus">
                        <span class="bus-label">PresenceEngine.process_event()</span>
                    </div>
                    <div class="event-arrow">↓</div>
                    <div class="event-handlers">
                        <span>Pattern Learning</span>
                        <span>Activity Inference</span>
                        <span>Room Occupancy</span>
                        <span>Cross-Domain Triggers</span>
                    </div>
                </figure>

                <h3>What Triggers What</h3>
                <figure class="event-table">
                    <div class="event-row event-header">
                        <span>Event Type</span>
                        <span>Source</span>
                        <span>Reaction</span>
                    </div>
                    <div class="event-row">
                        <span><code>motion</code> / <code>person</code></span>
                        <span>UniFi cameras</span>
                        <span>Update room occupancy, trigger lights</span>
                    </div>
                    <div class="event-row">
                        <span><code>ring</code></span>
                        <span>Doorbell</span>
                        <span>Camera snapshot, announcement</span>
                    </div>
                    <div class="event-row">
                        <span><code>connect</code> / <code>disconnect</code></span>
                        <span>UniFi WiFi</span>
                        <span>Device presence, owner location</span>
                    </div>
                    <div class="event-row">
                        <span><code>zone_open</code></span>
                        <span>DSC security</span>
                        <span>Room entered, presence confirmed</span>
                    </div>
                </figure>

                <h3>Polling Fallbacks</h3>
                <p>
                    When WebSocket isn't available, adaptive polling fills the gap. Base intervals 
                    range from 15 seconds (presence) to 600 seconds (sleep data), multiplied by 
                    wakefulness and activity factors.
                </p>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 16: THE YAK SHAVES
         Mood: Honesty. The real work behind the work.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-yaks">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XV</span>
                <h2 class="scene-title">The Lessons</h2>
                <p class="scene-subtitle">What I learned building this</p>
            </div>

            <div class="lessons-grid">
                
                <article class="lesson">
                    <span class="lesson-number">01</span>
                    <h3>Token management is its own microservice</h3>
                    <p>
                        Control4's 3-step authentication, 24-hour expiry, and refresh dance taught me: 
                        treat auth as infrastructure, not afterthought. Build it robust from day one.
                    </p>
                </article>

                <article class="lesson">
                    <span class="lesson-number">02</span>
                    <h3>Enterprise features have escape hatches</h3>
                    <p>
                        UniFi's 2FA blocked automation until I found the undocumented local admin account.
                        When an API seems impossible, there's usually a path—keep digging.
                    </p>
                </article>

                <article class="lesson">
                    <span class="lesson-number">03</span>
                    <h3>APIs you don't control will break</h3>
                    <p>
                        Tesla deprecated their Vehicle API overnight. Eight Sleep changed their auth flow.
                        Every integration needs circuit breakers and fallback paths. No exceptions.
                    </p>
                </article>

                <article class="lesson">
                    <span class="lesson-number">04</span>
                    <h3>Experimentation is documentation</h3>
                    <p>
                        Denon's input names ("MPLAY", "SAT/CBL") don't match their UI labels.
                        I tried every combination. Now my code IS the documentation.
                    </p>
                </article>

                <article class="lesson">
                    <span class="lesson-number">05</span>
                    <h3>Initialization order matters</h3>
                    <p>
                        Nine integrations connecting simultaneously overwhelmed Denon's telnet port.
                        The fix: exponential backoff, jitter, and generous timeouts.
                    </p>
                </article>

                <article class="lesson">
                    <span class="lesson-number">06</span>
                    <h3>Rate limits are friends, not enemies</h3>
                    <p>
                        Eight Sleep's rate limiting taught me: respect the API's limits, 
                        read the <code>Retry-After</code> header, back off gracefully. Aggressive 
                        clients get blocked; patient ones stay connected.
                    </p>
                </article>

            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 17: UP NEXT
         Mood: Roadmap. The work continues.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-upnext">
        <div class="scene-container">
            
            <div class="scene-intro">
                <span class="scene-number">XVI</span>
                <h2 class="scene-title">Up Next</h2>
                <p class="scene-subtitle">Code exists. Wiring awaits.</p>
            </div>

            <div class="upnext-grid">
                <div class="upnext-item">
                    <span class="upnext-name">Eight Sleep</span>
                    <span class="upnext-status">Rate limit cooldown</span>
                    <p>Sleep tracking and temperature control. Auth fixed, waiting for API rate limit to clear.</p>
                </div>
                <div class="upnext-item">
                    <span class="upnext-name">Samsung TV</span>
                    <span class="upnext-status">Network discovery</span>
                    <p>Tizen SmartThings code ready. Device not responding to wake packets.</p>
                </div>
                <div class="upnext-item">
                    <span class="upnext-name">Apple Health</span>
                    <span class="upnext-status">iOS permissions</span>
                    <p>Heart rate and activity for circadian automation. Needs HealthKit permission flow.</p>
                </div>
                <div class="upnext-item">
                    <span class="upnext-name">Glowforge</span>
                    <span class="upnext-status">Cloud-only API</span>
                    <p>Can detect presence on network. Control requires their app—no local API.</p>
                </div>
            </div>

        </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SCENE 18: CLOSING
         Mood: Satisfaction. The promise fulfilled.
         ═══════════════════════════════════════════════════════════════════════ -->

    <section class="scene scene-closing">
        <div class="scene-container">
            
            <div class="closing-content">
                <p class="closing-lead">
                    The house thinks now.
                </p>
                <p class="closing-text">
                    Nine physical integrations. Ten digital services. One command. 
                    Parallel execution. Real-time events. Adaptive polling. 
                    Pattern learning that improves over time.
                </p>
                <p class="closing-text">
                    When Control4 goes down, lights fall back to direct Lutron.
                    When UniFi fails, presence routes through Tesla geofencing.
                    Every integration has a circuit breaker. Every failure has a fallback.
                </p>
                <p class="closing-coda">
                    Not magic. Just engineering.
                </p>
            </div>

            <footer class="closing-footer">
                <a href="/art/home/" class="footer-link">See the house →</a>
                <span class="footer-divider">·</span>
                <span class="footer-location">Seattle · December 2025</span>
            </footer>

        </div>
    </section>

    <script src="js/main.js"></script>
</body>
</html>
