<!DOCTYPE html>
<html lang="en" data-é¡="mansion" data-theme="clue" data-ending="none">
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ğŸ›ï¸ THE HOUSE â€” A Clue-Themed Architectural Tour of Kagami
    
    "Ladies and gentlemen, you all have one thing in common... you're all lines of code."
    â€” Wadsworth
    
    FOR JILL â€” Product Manager Extraordinaire
    
    This is how the Kagami codebase is actually structured.
    Your favorite movie, mapping the architecture you help shape.
    
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a0f0f">
    <title>ğŸ›ï¸ THE HOUSE â€” A Clue-Themed Architectural Mystery | é¡ Kagami</title>
    <meta name="description" content="A murder mystery dinner party exploring the living architecture of Kagami.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›ï¸</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-content">
            <div class="loading-icon">ğŸ›ï¸</div>
            <div class="loading-quote">"I'm the butler. I buttle."</div>
            <div class="loading-bar"><div class="loading-progress" id="loading-progress"></div></div>
            <div class="loading-text">Preparing the mansion...</div>
        </div>
    </div>

    <!-- Canvas Layers -->
    <canvas id="candlelight-canvas"></canvas>
    <canvas id="dust-canvas"></canvas>
    <canvas id="passage-canvas"></canvas>

    <!-- Atmospheric Layers -->
    <div class="atmosphere">
        <div class="fog fog-1"></div>
        <div class="fog fog-2"></div>
        <div class="vignette"></div>
    </div>

    <!-- Custom Cursor -->
    <div id="cursor">
        <div class="cursor-dot"></div>
        <div class="cursor-ring"></div>
    </div>

    <!-- Main Content -->
    <div class="mansion">
        <!-- Header -->
        <header class="mansion-header">
            <div class="header-decoration">âœ§ âœ¦ âœ§</div>
            <h1 class="mansion-title">THE HOUSE</h1>
            <p class="mansion-subtitle">A Murder Mystery Dinner Party</p>
            <p class="mansion-tagline">"Ladies and gentlemen, you all have one thing in common..."</p>
        </header>

        <!-- For Jill -->
        <section class="dedication">
            <div class="dedication-frame">
                <p class="dedication-to">For Jill</p>
                <p class="dedication-role">Product Manager Â· Architectural Advisor Â· Clue Connoisseur</p>
                <p class="dedication-note">This is how Kagami worksâ€”not as documentation, but as experience.</p>
            </div>
        </section>

        <!-- The Mansion Tour -->
        <section class="investigation" id="investigation">
            <h2 class="section-title">The Mansion</h2>
            <p class="section-intro">
                <strong>Kagami</strong> is an AI system that thinks in seven different ways at once.<br>
                Instead of one "brain," it has seven specialized agents living in one house.<br>
                Like characters in a story, they argue, collaborate, and solve problems together.
            </p>
            
            <!-- Architecture Overview -->
            <div class="architecture-grid">
                <!-- API Layer -->
                <div class="arch-card" data-room="api">
                    <div class="arch-icon">ğŸšª</div>
                    <h3>The Front Door</h3>
                    <p class="arch-path">kagami/api/</p>
                    <p class="arch-desc">REST API & WebSocket endpoints. FastAPI routes, middleware, authentication. Where the outside world enters.</p>
                    <div class="arch-files">
                        <code>routes/</code> <code>middleware/</code> <code>socketio/</code>
                    </div>
                </div>
                
                <!-- Core Brain -->
                <div class="arch-card" data-room="core">
                    <div class="arch-icon">ğŸ§ </div>
                    <h3>The Study</h3>
                    <p class="arch-path">kagami/core/</p>
                    <p class="arch-desc">The brain. Orchestration, coordination, execution. Where decisions are made and work is routed.</p>
                    <div class="arch-files">
                        <code>orchestrator/</code> <code>coordination/</code> <code>execution/</code>
                    </div>
                </div>
                
                <!-- Services -->
                <div class="arch-card" data-room="services">
                    <div class="arch-icon">âš™ï¸</div>
                    <h3>The Kitchen</h3>
                    <p class="arch-path">kagami/core/services/</p>
                    <p class="arch-desc">Where the real work happens. LLM clients, embeddings, storage, MCP connections. The staff quarters.</p>
                    <div class="arch-files">
                        <code>llm/</code> <code>embedding_service.py</code> <code>mcp/</code>
                    </div>
                </div>
                
                <!-- World Model -->
                <div class="arch-card" data-room="world">
                    <div class="arch-icon">ğŸ”®</div>
                    <h3>The Attic</h3>
                    <p class="arch-path">kagami/core/world_model/</p>
                    <p class="arch-desc">Prediction engine. RSSM-based world simulation. Doesn't just reactâ€”it predicts what's coming.</p>
                    <div class="arch-files">
                        <code>equivariance/</code> <code>layers/</code> <code>memory/</code>
                    </div>
                </div>
                
                <!-- Safety -->
                <div class="arch-card arch-card-danger" data-room="safety">
                    <div class="arch-icon">ğŸ›¡ï¸</div>
                    <h3>The Walls</h3>
                    <p class="arch-path">kagami/core/safety/</p>
                    <p class="arch-desc">Control Barrier Functions. <strong>h(x) â‰¥ 0. ALWAYS.</strong> The walls that keep danger out.</p>
                    <div class="arch-files">
                        <code>optimal_cbf.py</code> <code>barriers/</code>
                    </div>
                </div>
                
                <!-- Math -->
                <div class="arch-card" data-room="math">
                    <div class="arch-icon">ğŸ“</div>
                    <h3>The Basement</h3>
                    <p class="arch-path">kagami/math/</p>
                    <p class="arch-desc">Mathematical foundations. E8 lattice quantization, Fano plane routing, octonion algebra.</p>
                    <div class="arch-files">
                        <code>e8_lattice_quantizer.py</code> <code>fano_plane.py</code> <code>octonions/</code>
                    </div>
                </div>
                
                <!-- Memory -->
                <div class="arch-card" data-room="memory">
                    <div class="arch-icon">ğŸ’¾</div>
                    <h3>The Library</h3>
                    <p class="arch-path">kagami/core/memory/</p>
                    <p class="arch-desc">Episodic and semantic memory. Vector stores, retrieval, the system's long-term knowledge.</p>
                    <div class="arch-files">
                        <code>episodic/</code> <code>semantic/</code> <code>retrieval/</code>
                    </div>
                </div>
                
                <!-- Database -->
                <div class="arch-card" data-room="database">
                    <div class="arch-icon">ğŸ—„ï¸</div>
                    <h3>The Cellar</h3>
                    <p class="arch-path">kagami/core/database/</p>
                    <p class="arch-desc">PostgreSQL connections, migrations, models. Where everything is stored permanently.</p>
                    <div class="arch-files">
                        <code>connection.py</code> <code>models/</code>
                    </div>
                </div>
            </div>
            
            <!-- The Suspects: Key Components -->
            <div class="suspects-compact">
                <h3 class="subsection-title">The Suspects</h3>
                <p class="subsection-intro">The key players in every request:</p>
                
                <div class="suspect-row">
                    <div class="suspect-mini" data-character="scarlet">
                        <span class="suspect-icon">ğŸ”¥</span>
                        <span class="suspect-name">Miss Scarlet</span>
                        <span class="suspect-role">Intent Parser</span>
                    </div>
                    <div class="suspect-mini" data-character="mustard">
                        <span class="suspect-icon">âš’ï¸</span>
                        <span class="suspect-name">Col. Mustard</span>
                        <span class="suspect-role">Task Executor</span>
                    </div>
                    <div class="suspect-mini" data-character="white">
                        <span class="suspect-icon">ğŸŒŠ</span>
                        <span class="suspect-name">Mrs. White</span>
                        <span class="suspect-role">Error Handler</span>
                    </div>
                    <div class="suspect-mini" data-character="green">
                        <span class="suspect-icon">ğŸ”—</span>
                        <span class="suspect-name">Mr. Green</span>
                        <span class="suspect-role">Memory Manager</span>
                    </div>
                </div>
                <div class="suspect-row">
                    <div class="suspect-mini" data-character="plum">
                        <span class="suspect-icon">ğŸ—¼</span>
                        <span class="suspect-name">Prof. Plum</span>
                        <span class="suspect-role">Route Planner</span>
                    </div>
                    <div class="suspect-mini" data-character="peacock">
                        <span class="suspect-icon">ğŸ’</span>
                        <span class="suspect-name">Mrs. Peacock</span>
                        <span class="suspect-role">Validator</span>
                    </div>
                    <div class="suspect-mini" data-character="motorist">
                        <span class="suspect-icon">ğŸŒ¿</span>
                        <span class="suspect-name">The Motorist</span>
                        <span class="suspect-role">Retriever</span>
                    </div>
                    <div class="suspect-mini character-wadsworth" data-character="wadsworth">
                        <span class="suspect-icon">ğŸ›ï¸</span>
                        <span class="suspect-name">Wadsworth</span>
                        <span class="suspect-role">Orchestrator</span>
                    </div>
                </div>
            </div>
            
            <!-- Secret Passages: Module Dependencies -->
            <div class="passages-compact">
                <h3 class="subsection-title">Secret Passages</h3>
                <p class="subsection-intro">How modules connect:</p>
                
                <div class="passage-grid">
                    <div class="passage-mini">
                        <span class="passage-from">API</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Orchestrator</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Services</span>
                    </div>
                    <div class="passage-mini">
                        <span class="passage-from">World Model</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Safety</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Execution</span>
                    </div>
                    <div class="passage-mini">
                        <span class="passage-from">Memory</span>
                        <span class="passage-arrow">â†”</span>
                        <span class="passage-to">Database</span>
                        <span class="passage-arrow">â†”</span>
                        <span class="passage-to">Cache</span>
                    </div>
                    <div class="passage-mini">
                        <span class="passage-from">Math</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Quantization</span>
                        <span class="passage-arrow">â†’</span>
                        <span class="passage-to">Embeddings</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Request Lifecycle -->
        <section class="lifecycle" id="lifecycle">
            <h2 class="section-title">The Murder</h2>
            <p class="section-subtitle">"One plus one plus two plus one..."</p>
            <p class="section-intro">
                What happens when a request enters the mansion?<br>
                Follow the body through the house.
            </p>
            
            <div class="lifecycle-flow">
                <div class="lifecycle-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>The Doorbell</h4>
                        <code>api/routes/</code>
                        <p>Request arrives via REST or WebSocket</p>
                    </div>
                </div>
                <div class="lifecycle-arrow">â†“</div>
                
                <div class="lifecycle-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>The Butler Answers</h4>
                        <code>orchestrator/process_intent_v2.py</code>
                        <p>Wadsworth parses intent, plans execution</p>
                    </div>
                </div>
                <div class="lifecycle-arrow">â†“</div>
                
                <div class="lifecycle-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Safety Check</h4>
                        <code>safety/optimal_cbf.py</code>
                        <p>Is h(x) â‰¥ 0? Can we proceed?</p>
                    </div>
                </div>
                <div class="lifecycle-arrow">â†“</div>
                
                <div class="lifecycle-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>The Kitchen</h4>
                        <code>services/llm/service.py</code>
                        <p>LLM generates response, tools execute</p>
                    </div>
                </div>
                <div class="lifecycle-arrow">â†“</div>
                
                <div class="lifecycle-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h4>The Response</h4>
                        <code>api/socketio/broadcaster.py</code>
                        <p>Stream back to client</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- The Walls (Safety) -->
        <section class="walls" id="walls">
            <h2 class="section-title">The Walls</h2>
            <p class="section-subtitle">"h(x) â‰¥ 0. ALWAYS."</p>
            
            <div class="safety-hero">
                <div class="safety-formula">h(x) â‰¥ 0</div>
                <p class="safety-explain">The safety barrier must never be violated</p>
            </div>
            
            <div class="safety-zones">
                <div class="safety-zone safe">
                    <div class="zone-indicator">h(x) > 0.5</div>
                    <div class="zone-status">ğŸŸ¢ Safe</div>
                    <p>Proceed normally</p>
                </div>
                <div class="safety-zone caution">
                    <div class="zone-indicator">0 â‰¤ h(x) â‰¤ 0.5</div>
                    <div class="zone-status">ğŸŸ¡ Verify</div>
                    <p>Extra validation required</p>
                </div>
                <div class="safety-zone danger">
                    <div class="zone-indicator">h(x) < 0</div>
                    <div class="zone-status">ğŸ”´ STOP</div>
                    <p>Operation blocked</p>
                </div>
            </div>
            
            <blockquote class="safety-quote">
                "The safety invariant is INVIOLABLE."<br>
                <span class="quote-attr">â€” Like Mrs. Peacock's sense of propriety</span>
            </blockquote>
        </section>

        <!-- The Endings -->
        <section class="endings" id="endings">
            <h2 class="section-title">The Endings</h2>
            <p class="section-intro">
                Just like the movie had three endings, there are three ways to understand this architecture.
            </p>
            
            <div class="ending-buttons">
                <button class="ending-btn" data-ending="A">
                    <span class="ending-letter">A</span>
                    <span class="ending-title">The Data Flow</span>
                    <span class="ending-quote">"That's how it could have happened."</span>
                </button>
                <button class="ending-btn" data-ending="B">
                    <span class="ending-letter">B</span>
                    <span class="ending-title">The Safety View</span>
                    <span class="ending-quote">"But here's what really happened..."</span>
                </button>
                <button class="ending-btn" data-ending="C">
                    <span class="ending-letter">C</span>
                    <span class="ending-title">The Full Picture</span>
                    <span class="ending-quote">"But here's what REALLY happened."</span>
                </button>
            </div>
            
            <div class="ending-content" id="ending-content">
                <p class="ending-placeholder">Click an ending to reveal...</p>
            </div>
        </section>

        <!-- The Reveal -->
        <section class="reveal" id="reveal">
            <h2 class="section-title">The Reveal</h2>
            
            <div class="wadsworth-speech">
                <div class="speech-icon">ğŸ›ï¸</div>
                <blockquote class="speech-quote">
                    "Let me explain... No, there is too much. Let me sum up."
                </blockquote>
            </div>
            
            <div class="evidence-board">
                <div class="evidence-item">
                    <span class="evidence-value" data-count="401000">0</span>
                    <span class="evidence-label">Lines of Code</span>
                </div>
                <div class="evidence-item">
                    <span class="evidence-value" data-count="2557">0</span>
                    <span class="evidence-label">Python Files</span>
                </div>
                <div class="evidence-item">
                    <span class="evidence-value" data-count="3881">0</span>
                    <span class="evidence-label">Commits</span>
                </div>
                <div class="evidence-item">
                    <span class="evidence-value" data-count="7">0</span>
                    <span class="evidence-label">Satellites</span>
                </div>
                <div class="evidence-item">
                    <span class="evidence-value" data-count="45">0</span>
                    <span class="evidence-label">API Routes</span>
                </div>
                <div class="evidence-item">
                    <span class="evidence-value" data-count="3">0</span>
                    <span class="evidence-label">Safety Tiers</span>
                </div>
            </div>
            
            <div class="final-equation">
                <p class="equation-setup">One plus one plus two plus one...</p>
                <div class="equation-result">
                    <span class="eq-term">ğŸšª</span>
                    <span class="eq-term">+</span>
                    <span class="eq-term">ğŸ§ </span>
                    <span class="eq-term">+</span>
                    <span class="eq-term">âš™ï¸</span>
                    <span class="eq-term">+</span>
                    <span class="eq-term">ğŸ›¡ï¸</span>
                    <span class="eq-term">+</span>
                    <span class="eq-term">ğŸ’¾</span>
                    <span class="eq-term">=</span>
                    <span class="eq-sum">ğŸ›ï¸</span>
                </div>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="mansion-footer">
            <div class="footer-divider"></div>
            <blockquote class="footer-quote">
                "They all did it. But if you want to know who killed Mr. Body,<br>
                I did. In the Hall. With the architecture."
            </blockquote>
            <div class="footer-logo">
                <span class="logo-kanji">é¡</span>
                <span class="logo-text">Kagami</span>
            </div>
            <p class="footer-meta">December 2025 Â· Visit #<span id="visit-count">1</span></p>
            <p class="footer-wadsworth">"I'm the butler. I buttle."</p>
        </footer>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">Ã—</button>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="characters.js"></script>
    <script src="mansion.js"></script>

    <script src="../lib/realtime-voice.js"></script>
    <script src="../lib/kagami-voices.js"></script>
    <script src="../lib/voice-overlay.js"></script>
    <script>
        VoiceOverlay.init({
            project: 'clue',
            tools: [
                // â”€â”€â”€ PERCEPTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    name: 'observe_mansion',
                    description: 'Perceive the full state of the mansion page: loading state, which section is visible, current ending selected, modal state, visit count, secrets found, scroll position.',
                    parameters: { type: 'object', properties: {}, required: [] },
                },
                {
                    name: 'read_character',
                    description: 'Read the full details of a Clue character including their Kagami colony mapping, catastrophe type, octonion basis, role, room, essence, code path, full description, and movie quotes.',
                    parameters: {
                        type: 'object',
                        properties: { key: { type: 'string', description: 'Character key: scarlet, mustard, white, green, plum, peacock, motorist, wadsworth' } },
                        required: ['key'],
                    },
                },
                {
                    name: 'read_room',
                    description: 'Read the full details of a mansion room including its Kagami module mapping, colony, icon, floor, character association, function, and code path.',
                    parameters: {
                        type: 'object',
                        properties: { key: { type: 'string', description: 'Room key: conservatory, billiard, kitchen, dining, ballroom, study, library, lounge, hall, attic, basement, walls' } },
                        required: ['key'],
                    },
                },
                {
                    name: 'read_secret_passages',
                    description: 'Read all secret passages (Fano plane lines) showing how colony pairs compose to produce a third colony.',
                    parameters: { type: 'object', properties: {}, required: [] },
                },
                {
                    name: 'read_ending',
                    description: 'Read the content of a specific ending (A, B, or C) without triggering the UI reveal.',
                    parameters: {
                        type: 'object',
                        properties: { ending: { type: 'string', enum: ['A', 'B', 'C'], description: 'Ending letter' } },
                        required: ['ending'],
                    },
                },
                {
                    name: 'survey_all_characters',
                    description: 'Get a compact overview of all 8 characters with their colony, catastrophe, room, and role mappings.',
                    parameters: { type: 'object', properties: {}, required: [] },
                },
                // â”€â”€â”€ ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    name: 'scroll_to_section',
                    description: 'Scroll smoothly to a section of the mansion page.',
                    parameters: {
                        type: 'object',
                        properties: { section: { type: 'string', enum: ['investigation', 'lifecycle', 'walls', 'endings', 'reveal'], description: 'Section ID to scroll to' } },
                        required: ['section'],
                    },
                },
                {
                    name: 'show_room_modal',
                    description: 'Open the room detail modal for a specific room, showing its character, colony, description, and a random quote.',
                    parameters: {
                        type: 'object',
                        properties: { room: { type: 'string', description: 'Room key (e.g. study, library, hall, conservatory)' } },
                        required: ['room'],
                    },
                },
                {
                    name: 'show_character_modal',
                    description: 'Open the character detail modal for a specific character, showing their full description, colony mapping, and quotes.',
                    parameters: {
                        type: 'object',
                        properties: { character: { type: 'string', description: 'Character key (e.g. scarlet, wadsworth, plum)' } },
                        required: ['character'],
                    },
                },
                {
                    name: 'reveal_ending',
                    description: 'Trigger one of the three endings (A: Mathematical, B: Safety, C: Full Picture) in the Endings section.',
                    parameters: {
                        type: 'object',
                        properties: { ending: { type: 'string', enum: ['A', 'B', 'C'], description: 'Which ending to reveal' } },
                        required: ['ending'],
                    },
                },
                {
                    name: 'activate_secret',
                    description: 'Trigger one of the hidden easter egg sequences: flames (Mrs. White\'s meltdown), wadsworth (the butler explains), passages (reveal Fano connections).',
                    parameters: {
                        type: 'object',
                        properties: { secret: { type: 'string', enum: ['flames', 'wadsworth', 'passages'], description: 'Which secret to activate' } },
                        required: ['secret'],
                    },
                },
                {
                    name: 'close_modal',
                    description: 'Close any open modal dialog.',
                    parameters: { type: 'object', properties: {}, required: [] },
                },
            ],
            onFunctionCall: (name, args) => {
                // â”€â”€â”€ PERCEPTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (name === 'observe_mansion') {
                    const loadingEl = document.getElementById('loading');
                    const loading = loadingEl && !loadingEl.classList.contains('hidden');
                    const modalEl = document.querySelector('.modal');
                    const modalOpen = modalEl && modalEl.classList.contains('active');
                    const endingContent = document.getElementById('ending-content');
                    const currentEnding = document.documentElement.dataset.ending || 'none';

                    // Determine visible section
                    const viewMid = window.innerHeight / 2;
                    let visibleSection = 'top';
                    const sectionIds = ['investigation', 'lifecycle', 'walls', 'endings', 'reveal'];
                    for (const id of sectionIds) {
                        const el = document.getElementById(id);
                        if (el) {
                            const r = el.getBoundingClientRect();
                            if (r.top <= viewMid && r.bottom >= viewMid) { visibleSection = id; break; }
                        }
                    }

                    // Read visit count from DOM
                    const visitEl = document.getElementById('visit-count');
                    const visits = visitEl ? visitEl.textContent : '?';

                    // Get secrets from localStorage
                    const secrets = JSON.parse(localStorage.getItem('mansion_secrets') || '[]');

                    return {
                        loading,
                        visible_section: visibleSection,
                        current_ending: currentEnding,
                        modal_open: modalOpen,
                        visit_count: visits,
                        secrets_found: secrets,
                        scroll_y: Math.round(window.scrollY),
                        scroll_percent: Math.round((window.scrollY / Math.max(1, document.body.scrollHeight - window.innerHeight)) * 100),
                        total_characters: typeof CHARACTERS !== 'undefined' ? Object.keys(CHARACTERS).length : 0,
                        total_rooms: typeof ROOMS !== 'undefined' ? Object.keys(ROOMS).length : 0,
                        total_passages: typeof SECRET_PASSAGES !== 'undefined' ? SECRET_PASSAGES.length : 0,
                    };
                }

                if (name === 'read_character') {
                    if (typeof CHARACTERS === 'undefined') return { error: 'Characters not loaded yet' };
                    const c = CHARACTERS[args.key];
                    if (!c) return { error: `Character "${args.key}" not found. Keys: ${Object.keys(CHARACTERS).join(', ')}` };
                    return {
                        key: args.key,
                        name: c.name,
                        colony: c.colony,
                        basis: c.basis,
                        catastrophe: c.catastrophe,
                        role: c.role,
                        room: c.room,
                        color: c.color,
                        essence: c.essence,
                        code_path: c.code,
                        description: c.description,
                        quotes: c.quotes,
                    };
                }

                if (name === 'read_room') {
                    if (typeof ROOMS === 'undefined') return { error: 'Rooms not loaded yet' };
                    const r = ROOMS[args.key];
                    if (!r) return { error: `Room "${args.key}" not found. Keys: ${Object.keys(ROOMS).join(', ')}` };
                    const character = r.character && CHARACTERS ? CHARACTERS[r.character] : null;
                    return {
                        key: args.key,
                        name: r.name,
                        colony: r.colony,
                        icon: r.icon,
                        floor: r.floor,
                        description: r.description,
                        function: r.function,
                        code_path: r.codePath,
                        character: character ? { name: character.name, colony: character.colony, catastrophe: character.catastrophe } : null,
                    };
                }

                if (name === 'read_secret_passages') {
                    if (typeof SECRET_PASSAGES === 'undefined') return { error: 'Passages not loaded' };
                    return {
                        passages: SECRET_PASSAGES.map(p => ({
                            from: p.from,
                            to: p.to,
                            colonies: p.colonies,
                            result: p.result,
                            fano_line: p.fanoLine,
                            description: p.description,
                        })),
                        note: 'Each passage represents a Fano plane line: colony_a Ã— colony_b = colony_c (octonion multiplication)',
                    };
                }

                if (name === 'read_ending') {
                    if (typeof ENDINGS === 'undefined') return { error: 'Endings not loaded' };
                    const e = ENDINGS[args.ending];
                    if (!e) return { error: 'Ending not found' };
                    // Strip HTML tags for text content
                    const div = document.createElement('div');
                    div.innerHTML = e.content;
                    return { letter: args.ending, title: e.title, tagline: e.tagline, focus: e.focus, content_text: div.textContent.trim() };
                }

                if (name === 'survey_all_characters') {
                    if (typeof CHARACTERS === 'undefined') return { error: 'Characters not loaded' };
                    return {
                        characters: Object.entries(CHARACTERS).map(([key, c]) => ({
                            key,
                            name: c.name,
                            colony: c.colony,
                            basis: c.basis,
                            catastrophe: c.catastrophe,
                            role: c.role,
                            room: c.room,
                        })),
                    };
                }

                // â”€â”€â”€ ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (name === 'scroll_to_section') {
                    const el = document.getElementById(args.section);
                    if (!el) return { error: `Section "${args.section}" not found` };
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return { status: 'scrolling', target: args.section };
                }

                if (name === 'show_room_modal') {
                    if (typeof window.mansion !== 'undefined' && window.mansion.investigate) {
                        window.mansion.investigate(args.room);
                        return { status: 'opened', room: args.room };
                    }
                    return { error: 'Mansion not initialized' };
                }

                if (name === 'show_character_modal') {
                    if (typeof window.mansion !== 'undefined' && window.mansion.suspect) {
                        window.mansion.suspect(args.character);
                        // Also programmatically open the modal
                        const modalBody = document.getElementById('modal-body');
                        const modal = document.querySelector('.modal');
                        if (typeof CHARACTERS !== 'undefined' && CHARACTERS[args.character] && modalBody && modal) {
                            const c = CHARACTERS[args.character];
                            const quote = c.quotes[Math.floor(Math.random() * c.quotes.length)];
                            const icons = { Spark: 'ğŸ”¥', Forge: 'âš’ï¸', Flow: 'ğŸŒŠ', Nexus: 'ğŸ”—', Beacon: 'ğŸ—¼', Grove: 'ğŸŒ¿', Crystal: 'ğŸ’', Kagami: 'ğŸ›ï¸' };
                            modalBody.innerHTML = `<div style="border-left:3px solid ${c.color};padding-left:1rem;"><div style="font-size:3rem;text-align:center;margin-bottom:1rem;">${icons[c.colony]||'âœ§'}</div><h3>${c.name}</h3><p style="opacity:0.6;">${c.colony} Â· ${c.basis} Â· ${c.catastrophe}</p><p><strong>Room:</strong> ${c.room}</p><p><strong>Role:</strong> ${c.role}</p><blockquote>"${quote}"</blockquote><p>${c.description}</p><p><code>${c.code}</code></p></div>`;
                            modal.classList.add('active');
                        }
                        return { status: 'opened', character: args.character };
                    }
                    return { error: 'Mansion not initialized' };
                }

                if (name === 'reveal_ending') {
                    if (typeof window.mansion !== 'undefined' && window.mansion.ending) {
                        window.mansion.ending(args.ending);
                    } else {
                        // Fallback: directly set
                        if (typeof ENDINGS !== 'undefined' && ENDINGS[args.ending]) {
                            const ec = document.getElementById('ending-content');
                            if (ec) { ec.innerHTML = ENDINGS[args.ending].content; ec.classList.add('visible'); }
                            document.documentElement.dataset.ending = args.ending;
                        }
                    }
                    // Also scroll to endings
                    const endingsEl = document.getElementById('endings');
                    if (endingsEl) endingsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Highlight the active button
                    document.querySelectorAll('.ending-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.ending === args.ending);
                    });
                    return { status: 'revealed', ending: args.ending, tagline: typeof ENDINGS !== 'undefined' ? ENDINGS[args.ending]?.tagline : '' };
                }

                if (name === 'activate_secret') {
                    if (typeof window.mansion !== 'undefined') {
                        if (args.secret === 'flames' && window.mansion.flames) { window.mansion.flames(); return { status: 'activated', secret: 'flames', quote: 'Flames... flames on the side of my face...' }; }
                        if (args.secret === 'wadsworth' && window.mansion.wadsworth) { window.mansion.wadsworth(); return { status: 'activated', secret: 'wadsworth', quote: 'Let me explain...' }; }
                        if (args.secret === 'passages') {
                            document.body.classList.add('passage-reveal');
                            setTimeout(() => document.body.classList.remove('passage-reveal'), 5000);
                            return { status: 'activated', secret: 'passages', note: 'Secret passages revealed for 5 seconds' };
                        }
                    }
                    return { error: 'Mansion not initialized or secret not recognized' };
                }

                if (name === 'close_modal') {
                    const modal = document.querySelector('.modal');
                    if (modal) modal.classList.remove('active');
                    return { status: 'closed' };
                }

                return { ok: true };
            },
        });
    </script>
</body>
</html>
