<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Master of Puppets â€” A Fantasia</title>
    <meta name="description" content="The orchestral transformation of Metallica's Master of Puppets. A visual symphony with real-time note visualization.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ»</text></svg>">

    <!-- Open Graph / Social -->
    <meta property="og:title" content="Master of Puppets â€” A Fantasia">
    <meta property="og:description" content="The orchestral transformation of Metallica's Master of Puppets. A visual symphony.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Theme -->
    <meta name="theme-color" content="#030305">
    <meta name="color-scheme" content="dark">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MASTER OF PUPPETS â€” A FANTASIA
   
   Real-time orchestral visualization with millisecond note accuracy
   
   h(x) â‰¥ 0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    /* The Void & Light */
    --void: #030305;
    --void-warm: #0a0812;
    --void-purple: #0d0815;
    --light: #f8f6f2;
    --light-dim: rgba(248, 246, 242, 0.85);
    --light-faint: rgba(248, 246, 242, 0.6);
    
    /* The Orchestra Palette */
    --orch-gold: #e5b84a;
    --orch-copper: #b87333;
    --metal-red: #8b0000;
    
    /* Section Colors */
    --strings: #c19a6b;
    --woodwinds: #2e8b57;
    --brass: #ffd700;
    --percussion: #8b4513;
    
    /* Typography */
    --font-display: 'EB Garamond', Georgia, serif;
    --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
    --font-mono: 'IBM Plex Mono', monospace;
    
    /* Fibonacci Timing */
    --dur-233: 233ms;
    --dur-377: 377ms;
    --dur-610: 610ms;
    --dur-987: 987ms;
    --dur-1597: 1597ms;
    
    /* Easings */
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --ease-dramatic: cubic-bezier(0.68, -0.2, 0.32, 1.2);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
    font-family: var(--font-body);
    background: var(--void);
    color: var(--light);
    line-height: 1.8;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
}

::selection {
    background: var(--orch-gold);
    color: var(--void);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    position: relative;
    z-index: 10;
}

.title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 6vw, 4rem);
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    animation: title-emerge var(--dur-1597) var(--ease-out) forwards;
}

@keyframes title-emerge {
    0% { opacity: 0; transform: translateY(20px); filter: blur(8px); }
    100% { opacity: 1; transform: translateY(0); filter: blur(0); }
}

.subtitle {
    font-family: var(--font-display);
    font-size: clamp(1rem, 2vw, 1.25rem);
    font-style: italic;
    color: var(--light-dim);
    letter-spacing: 0.15em;
}

.meta {
    margin-top: 1rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--light-faint);
}

.meta span { margin: 0 0.75rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORCHESTRA STAGE â€” Carnegie Hall Layout
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.orchestra-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.stage {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 10;
    background: radial-gradient(ellipse 100% 80% at 50% 100%, rgba(139, 69, 19, 0.15) 0%, transparent 60%),
                radial-gradient(ellipse 80% 50% at 50% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                linear-gradient(180deg, var(--void) 0%, var(--void-warm) 100%);
    border-radius: 50% 50% 0 0 / 20% 20% 0 0;
    overflow: hidden;
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-bottom: none;
}

/* Stage edge glow */
.stage::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--orch-gold), transparent);
    opacity: 0.6;
}

/* Conductor podium */
.conductor {
    position: absolute;
    bottom: 5%;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    z-index: 100;
    animation: conductor-glow 3s ease-in-out infinite;
}

@keyframes conductor-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
    50% { box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSTRUMENT SECTIONS â€” True Orchestral Positioning
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.instrument {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: transform var(--dur-233) var(--ease-out);
    cursor: default;
    z-index: 10;
}

.instrument:hover {
    transform: scale(1.1);
    z-index: 20;
}

.instrument-icon {
    font-size: clamp(1.5rem, 3vw, 2.5rem);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    transition: all 100ms ease-out;
}

.instrument-label {
    font-family: var(--font-mono);
    font-size: clamp(0.5rem, 1vw, 0.7rem);
    color: var(--light-faint);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0;
    transform: translateY(-5px);
    transition: all var(--dur-233) var(--ease-out);
    white-space: nowrap;
}

.instrument:hover .instrument-label {
    opacity: 1;
    transform: translateY(0);
}

/* Note hit pulse */
.instrument.playing .instrument-icon {
    animation: note-pulse 150ms ease-out;
}

@keyframes note-pulse {
    0% { transform: scale(1); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
    50% { transform: scale(1.3); filter: drop-shadow(0 0 20px currentColor); }
    100% { transform: scale(1); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
}

/* Section-specific glows */
.instrument[data-section="strings"] .instrument-icon { color: var(--strings); }
.instrument[data-section="woodwinds"] .instrument-icon { color: var(--woodwinds); }
.instrument[data-section="brass"] .instrument-icon { color: var(--brass); }
.instrument[data-section="percussion"] .instrument-icon { color: var(--percussion); }

.instrument[data-section="strings"].playing .instrument-icon {
    filter: drop-shadow(0 0 25px var(--strings)) drop-shadow(0 0 50px var(--strings));
}
.instrument[data-section="woodwinds"].playing .instrument-icon {
    filter: drop-shadow(0 0 25px var(--woodwinds)) drop-shadow(0 0 50px var(--woodwinds));
}
.instrument[data-section="brass"].playing .instrument-icon {
    filter: drop-shadow(0 0 25px var(--brass)) drop-shadow(0 0 50px var(--brass));
}
.instrument[data-section="percussion"].playing .instrument-icon {
    filter: drop-shadow(0 0 25px var(--percussion)) drop-shadow(0 0 50px var(--percussion));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXACT ORCHESTRAL POSITIONS (Carnegie Hall / BBC Proms)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* === STRINGS (Front, curved arc) === */
/* Violins I - Stage left, closest to conductor */
.instrument[data-id="v1"] { left: 15%; bottom: 25%; }
/* Violins II - Inside left */
.instrument[data-id="v2"] { left: 28%; bottom: 30%; }
/* Violas - Center-right */
.instrument[data-id="va"] { left: 55%; bottom: 30%; }
/* Cellos - Right of conductor */
.instrument[data-id="vc"] { left: 70%; bottom: 25%; }
/* Basses - Far right, back */
.instrument[data-id="cb"] { left: 85%; bottom: 35%; }

/* === WOODWINDS (Second row, center) === */
/* Flutes - Center left */
.instrument[data-id="fl"] { left: 35%; bottom: 45%; }
/* Oboes - Center */
.instrument[data-id="ob"] { left: 45%; bottom: 48%; }
/* Clarinets - Center right */
.instrument[data-id="cl"] { left: 55%; bottom: 45%; }
/* Bassoons - Right of center */
.instrument[data-id="bn"] { left: 65%; bottom: 48%; }

/* === BRASS (Third row, spread wide) === */
/* Horns - Left center */
.instrument[data-id="hn"] { left: 25%; bottom: 58%; }
/* Trumpets - Center left */
.instrument[data-id="tp"] { left: 40%; bottom: 62%; }
/* Trombones - Center right */
.instrument[data-id="tb"] { left: 55%; bottom: 62%; }
/* Tuba - Right */
.instrument[data-id="tu"] { left: 70%; bottom: 58%; }

/* === PERCUSSION (Back row) === */
/* Timpani - Back center-left */
.instrument[data-id="ti"] { left: 35%; bottom: 78%; }
/* Harp - Far left */
.instrument[data-id="hp"] { left: 8%; bottom: 55%; }
/* Celeste - Far left, behind harp */
.instrument[data-id="ce"] { left: 12%; bottom: 70%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO PLAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, transparent, rgba(3, 3, 5, 0.95) 30%);
    padding: 2rem;
    z-index: 1000;
}

.player-inner {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.player-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
}

.play-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 2px solid var(--orch-gold);
    background: transparent;
    color: var(--orch-gold);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    transition: all var(--dur-233) var(--ease-out);
}

.play-btn:hover {
    background: var(--orch-gold);
    color: var(--void);
    transform: scale(1.1);
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
}

.play-btn:focus-visible {
    outline: 3px solid var(--light);
    outline-offset: 3px;
}

.play-btn.playing {
    background: var(--orch-gold);
    color: var(--void);
    animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
    50% { box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); }
}

.time-display {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--light-dim);
    min-width: 100px;
    text-align: center;
}

.progress-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(248, 246, 242, 0.1);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--metal-red), var(--orch-gold));
    border-radius: 3px;
    width: 0%;
    transition: width 50ms linear;
}

.progress-bar:hover .progress-fill {
    background: linear-gradient(90deg, var(--orch-gold), #fff);
}

/* Volume */
.volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.volume-icon {
    font-size: 1.2rem;
    cursor: pointer;
}

.volume-slider {
    width: 80px;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(248, 246, 242, 0.2);
    border-radius: 2px;
    outline: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--orch-gold);
    cursor: pointer;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVITY VISUALIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.activity-ring {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
}

.activity-ring.active {
    animation: ring-expand 600ms ease-out forwards;
}

@keyframes ring-expand {
    0% {
        transform: scale(0.5);
        opacity: 0.8;
        border: 3px solid currentColor;
    }
    100% {
        transform: scale(2.5);
        opacity: 0;
        border: 1px solid currentColor;
    }
}

/* Section activity bars */
.section-meters {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 100;
}

.section-meter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.section-meter-label {
    width: 70px;
    text-align: right;
}

.section-meter-bar {
    width: 60px;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    overflow: hidden;
}

.section-meter-fill {
    height: 100%;
    width: 0%;
    transition: width 100ms ease-out;
    border-radius: 2px;
}

.section-meter[data-section="strings"] .section-meter-fill { background: var(--strings); }
.section-meter[data-section="woodwinds"] .section-meter-fill { background: var(--woodwinds); }
.section-meter[data-section="brass"] .section-meter-fill { background: var(--brass); }
.section-meter[data-section="percussion"] .section-meter-fill { background: var(--percussion); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.info-panel {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 2rem 8rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
}

.info-card {
    background: rgba(20, 15, 25, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.15);
    border-radius: 8px;
    padding: 1.5rem;
}

.info-card h3 {
    font-family: var(--font-display);
    font-size: 1.25rem;
    color: var(--orch-gold);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-card p {
    color: var(--light-dim);
    font-size: 0.9rem;
    line-height: 1.7;
}

.info-card ul {
    list-style: none;
    color: var(--light-dim);
    font-size: 0.85rem;
}

.info-card li {
    padding: 0.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-card li::before {
    content: 'â€¢';
    color: var(--orch-gold);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.footer {
    text-align: center;
    padding: 2rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--light-faint);
    background: linear-gradient(180deg, transparent, var(--void-warm));
}

.footer-symbol {
    font-size: 2rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: transform var(--dur-377) var(--ease-out);
}

.footer-symbol:hover {
    transform: scale(1.2) rotate(10deg);
    filter: drop-shadow(0 0 20px var(--orch-gold));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 768px) {
    .stage { aspect-ratio: 4 / 3; }
    .instrument-icon { font-size: 1.2rem; }
    .section-meters { display: none; }
    .player { padding: 1rem; }
    .play-btn { width: 56px; height: 56px; }
}

@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
    }
}
    </style>
</head>
<body>

<!-- Header -->
<header class="header">
    <h1 class="title">Master of Puppets</h1>
    <p class="subtitle">A Fantasia for Full Orchestra</p>
    <div class="meta">
        <span>E minor</span>
        <span>â€¢</span>
        <span>â™© = 212</span>
        <span>â€¢</span>
        <span>BBC Symphony Orchestra</span>
    </div>
</header>

<!-- Orchestra Stage -->
<main class="orchestra-container">
    <div class="stage" id="stage">
        <!-- Section Activity Meters -->
        <div class="section-meters">
            <div class="section-meter" data-section="strings">
                <span class="section-meter-label" style="color: var(--strings)">Strings</span>
                <div class="section-meter-bar"><div class="section-meter-fill"></div></div>
            </div>
            <div class="section-meter" data-section="woodwinds">
                <span class="section-meter-label" style="color: var(--woodwinds)">Woodwinds</span>
                <div class="section-meter-bar"><div class="section-meter-fill"></div></div>
            </div>
            <div class="section-meter" data-section="brass">
                <span class="section-meter-label" style="color: var(--brass)">Brass</span>
                <div class="section-meter-bar"><div class="section-meter-fill"></div></div>
            </div>
            <div class="section-meter" data-section="percussion">
                <span class="section-meter-label" style="color: var(--percussion)">Percussion</span>
                <div class="section-meter-bar"><div class="section-meter-fill"></div></div>
            </div>
        </div>

        <!-- Conductor -->
        <div class="conductor" title="Conductor">ğŸ¼</div>

        <!-- STRINGS -->
        <div class="instrument" data-id="v1" data-section="strings" title="Violins I (16)">
            <div class="instrument-icon">ğŸ»</div>
            <div class="instrument-label">Violins I</div>
        </div>
        <div class="instrument" data-id="v2" data-section="strings" title="Violins II (14)">
            <div class="instrument-icon">ğŸ»</div>
            <div class="instrument-label">Violins II</div>
        </div>
        <div class="instrument" data-id="va" data-section="strings" title="Violas (12)">
            <div class="instrument-icon">ğŸ»</div>
            <div class="instrument-label">Violas</div>
        </div>
        <div class="instrument" data-id="vc" data-section="strings" title="Cellos (10)">
            <div class="instrument-icon">ğŸ»</div>
            <div class="instrument-label">Cellos</div>
        </div>
        <div class="instrument" data-id="cb" data-section="strings" title="Double Basses (8)">
            <div class="instrument-icon">ğŸ»</div>
            <div class="instrument-label">Basses</div>
        </div>

        <!-- WOODWINDS -->
        <div class="instrument" data-id="fl" data-section="woodwinds" title="Flutes (3)">
            <div class="instrument-icon">ğŸªˆ</div>
            <div class="instrument-label">Flutes</div>
        </div>
        <div class="instrument" data-id="ob" data-section="woodwinds" title="Oboes (3)">
            <div class="instrument-icon">ğŸªˆ</div>
            <div class="instrument-label">Oboes</div>
        </div>
        <div class="instrument" data-id="cl" data-section="woodwinds" title="Clarinets (3)">
            <div class="instrument-icon">ğŸ·</div>
            <div class="instrument-label">Clarinets</div>
        </div>
        <div class="instrument" data-id="bn" data-section="woodwinds" title="Bassoons (3)">
            <div class="instrument-icon">ğŸ·</div>
            <div class="instrument-label">Bassoons</div>
        </div>

        <!-- BRASS -->
        <div class="instrument" data-id="hn" data-section="brass" title="French Horns (6)">
            <div class="instrument-icon">ğŸ“¯</div>
            <div class="instrument-label">Horns</div>
        </div>
        <div class="instrument" data-id="tp" data-section="brass" title="Trumpets (4)">
            <div class="instrument-icon">ğŸº</div>
            <div class="instrument-label">Trumpets</div>
        </div>
        <div class="instrument" data-id="tb" data-section="brass" title="Trombones (4)">
            <div class="instrument-icon">ğŸº</div>
            <div class="instrument-label">Trombones</div>
        </div>
        <div class="instrument" data-id="tu" data-section="brass" title="Tuba (2)">
            <div class="instrument-icon">ğŸ“¯</div>
            <div class="instrument-label">Tuba</div>
        </div>

        <!-- PERCUSSION -->
        <div class="instrument" data-id="ti" data-section="percussion" title="Timpani (4 drums)">
            <div class="instrument-icon">ğŸª˜</div>
            <div class="instrument-label">Timpani</div>
        </div>
        <div class="instrument" data-id="hp" data-section="percussion" title="Harp">
            <div class="instrument-icon">ğŸª•</div>
            <div class="instrument-label">Harp</div>
        </div>
        <div class="instrument" data-id="ce" data-section="percussion" title="Celeste">
            <div class="instrument-icon">ğŸ¹</div>
            <div class="instrument-label">Celeste</div>
        </div>
    </div>
</main>

<!-- Info Cards -->
<section class="info-panel">
    <div class="info-card">
        <h3>ğŸ» The Transformation</h3>
        <p>Every guitar riff becomes string tremolo. Every power chord becomes brass sforzando. The puppet strings are now violin strings.</p>
    </div>
    <div class="info-card">
        <h3>ğŸ“¯ 97 Musicians</h3>
        <ul>
            <li>60 String players</li>
            <li>13 Woodwind players</li>
            <li>18 Brass players</li>
            <li>6 Percussionists</li>
        </ul>
    </div>
    <div class="info-card">
        <h3>âš¡ Real-Time Sync</h3>
        <p>Each instrument lights up with millisecond accuracy as the notes play. The visualization reads directly from MIDI data.</p>
    </div>
</section>

<!-- Audio Player -->
<div class="player">
    <div class="player-inner">
        <div class="player-controls">
            <div class="volume-control">
                <span class="volume-icon" id="volume-icon">ğŸ”Š</span>
                <input type="range" class="volume-slider" id="volume" min="0" max="100" value="70">
            </div>
            <button class="play-btn" id="play-btn" aria-label="Play">â–¶</button>
            <div class="time-display" id="time">0:00 / 6:42</div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-symbol" title="é¡ - The Mirror">é¡</div>
    <p>Master of Puppets â€¢ Metallica (1986)<br>
    Orchestral Arrangement â€¢ Kagami (2026)<br>
    BBC Symphony Orchestra<br><br>
    h(x) â‰¥ 0</p>
</footer>

<!-- Audio Element -->
<audio id="audio" preload="auto">
    <source src="master-of-puppets.m4a" type="audio/mp4">
    Your browser does not support the audio element.
</audio>

<script>
(function() {
    'use strict';

    // =========================================================================
    // MIDI NOTE DATA â€” Millisecond accurate [start_ms, duration_ms, velocity]
    // =========================================================================
    
    const NOTES = {"v1":[[35002,255,82],[35279,255,82],[35562,255,86],[35843,255,83],[36139,255,83],[36412,255,88],[36702,255,85],[36985,255,85],[39526,255,83],[39804,255,86],[40089,255,82],[40380,255,86],[40654,255,87],[40944,255,84],[41227,255,86],[41516,255,84],[44063,255,87],[44346,255,86],[44617,255,83],[44907,255,86],[45183,255,88],[45468,255,82],[45756,255,85],[46038,255,84],[48579,255,88],[48869,255,88],[49158,255,83],[49427,255,84],[49720,255,84],[50004,255,87],[50278,255,85],[50568,255,84],[53104,255,88],[53398,255,88],[53682,255,82],[53960,255,87],[54251,255,83],[54536,255,85],[54810,255,86],[55101,255,87],[57637,255,87],[57918,255,83],[58207,255,84],[58491,255,83],[58766,255,85],[59054,255,82],[59339,255,86],[59619,255,82],[62165,255,86],[62449,255,84],[62730,255,85],[63011,255,83],[63294,255,88],[63583,255,83],[63860,255,86],[64143,255,82],[66692,255,84],[66984,255,88],[67266,255,87],[67555,255,87],[67825,255,87],[68117,255,83],[68390,255,82],[68678,255,87],[71227,255,87],[71502,255,87],[71799,255,84],[72068,255,88],[72360,255,84],[72637,255,84],[72932,255,85],[73205,255,83],[75000,71,108],[75072,71,102],[75144,71,104],[75212,3,108],[75278,5,103],[75352,71,107],[75429,71,102],[75487,13,103],[75570,71,102],[75633,8,103],[75712,71,106],[75786,71,106],[75848,9,104],[75917,1,102],[75983,5,107],[76069,71,108],[76138,1,105],[76197,12,107],[76276,71,108],[76344,3,102],[76417,71,103],[76489,71,105],[76556,4,104],[76622,5,107],[76694,71,108],[76761,4,104],[76843,71,106],[76902,12,102]],"v2":[[75006,71,100],[75071,6,99],[75146,71,103],[75206,12,100],[75279,71,101],[75354,71,101],[75417,8,102],[75489,71,98],[75570,71,97],[75640,71,102],[75714,71,101],[75775,9,101],[75845,1,97],[75920,71,100],[75984,6,102],[76059,71,101],[76128,1,97],[76201,71,99],[76269,3,100],[76344,71,103],[76410,5,101],[76492,71,98],[76550,13,101],[76630,71,101],[76695,5,103],[76762,4,98],[76836,71,100],[76915,71,100],[76973,13,103],[77050,71,101],[77121,71,102],[77192,71,97],[77269,71,101],[77341,71,103],[77398,14,98],[77483,71,101],[77553,71,97],[77623,1,98],[77690,4,101],[77757,4,103],[77838,71,102],[77903,5,101],[77975,71,99],[78037,9,102],[78117,71,98],[78186,1,101],[78248,9,101],[78319,71,98],[78391,71,101],[78463,71,97],[78531,3,99],[78611,71,102],[78675,6,102],[78751,71,103],[78826,71,103],[78886,10,100],[78961,71,101],[79033,71,98],[79110,71,102],[79176,5,102],[79242,4,101],[79309,4,98],[79392,71,102],[79459,4,97],[79528,1,98],[79605,71,100],[79666,10,103],[79747,71,101],[79816,1,98],[79887,71,100],[79960,71,100],[80022,9,99],[80089,4,99],[80169,71,103],[80239,71,100],[80312,71,101],[80372,10,99],[80447,71,101],[80511,6,103],[80595,71,97],[80664,1,97],[80733,1,103],[80804,71,101],[80876,71,102],[80947,71,102],[81014,4,100],[81089,71,100],[81153,6,99],[81226,71,103],[81303,71,100],[81361,13,100],[81442,71,98],[81503,10,103],[81586,71,103],[81656,1,100],[81719,8,102],[81791,71,98],[81858,4,102],[81935,71,103],[82010,71,97]],"va":[[4,1132,82],[1132,1132,84],[2258,1132,83],[3396,1132,85],[4530,1132,82],[5655,1132,83],[6790,1132,86],[7919,1132,88],[9059,1132,85],[10194,1132,83],[11328,1132,86],[12457,1132,87],[13590,1132,88],[14721,1132,83],[15849,1132,83],[16988,1132,82],[18120,1132,88],[19250,1132,87],[20375,1132,87],[21503,1132,86],[22634,1132,87],[23774,1132,87],[24911,1132,85],[26042,1132,84],[27163,1132,83],[28304,1132,85],[29439,1132,87],[30572,1132,84],[31695,1132,85],[32828,1132,83],[33960,1132,84],[35142,71,76],[35420,71,77],[35712,71,76],[35986,71,74],[36280,71,74],[36554,71,77],[36836,71,77],[37129,71,78],[37407,71,73],[37685,71,72],[37980,71,72],[38254,71,76],[38533,71,78],[38824,71,77],[39100,71,78],[39383,71,76],[39666,71,78],[39957,71,77],[40234,71,78],[40517,71,73],[40806,71,76],[41088,71,75],[41372,71,72],[41654,71,75],[41925,71,77],[42211,71,77],[42499,71,77],[42783,71,78],[43073,71,74],[43342,71,78],[43636,71,75],[43917,71,74],[44197,71,72],[44476,71,76],[44761,71,76],[45044,71,74],[45325,71,75],[45612,71,74],[45889,71,77],[46185,71,77],[46459,71,74],[46746,71,77],[47034,71,72],[47314,71,75],[47596,71,74],[47878,71,72],[48167,71,77],[48448,71,76],[48723,71,72],[49014,71,73],[49298,71,77],[49580,71,76],[49864,71,74],[50148,71,74],[50418,71,75],[50701,71,78],[50983,71,74],[51280,71,73],[51559,71,76],[51833,71,74],[52120,71,73],[52410,71,75],[52697,71,72],[52972,71,75],[53258,71,75],[53543,71,73],[53817,71,75],[54108,71,72],[54391,71,72]],"vc":[[4,63,89],[64,3,93],[136,64,87],[207,63,93],[278,63,91],[346,64,93],[423,64,87],[497,64,87],[572,63,87],[634,1,89],[708,63,91],[785,64,92],[853,64,88],[921,64,90],[989,64,88],[1060,64,87],[1135,64,88],[1208,63,93],[1277,64,92],[1337,5,88],[1418,64,93],[1490,64,91],[1551,3,87],[1627,63,92],[1698,64,93],[1768,64,91],[1840,64,89],[1914,63,91],[1979,64,92],[2056,63,88],[2119,63,88],[2191,64,92],[2262,64,88],[2334,63,93],[2399,63,89],[2478,63,90],[2542,64,88],[2623,63,89],[2693,64,92],[2763,64,92],[2826,1,93],[2893,64,90],[2974,63,88],[3049,64,92],[3118,63,88],[3183,64,90],[3247,64,87],[3322,64,88],[3398,63,90],[3462,64,92],[3530,63,90],[3601,64,87],[3675,64,92],[3746,64,93],[3813,64,91],[3897,64,89],[3958,3,89],[4034,64,87],[4100,64,92],[4177,64,88],[4245,63,88],[4319,64,93],[4382,1,88],[4456,64,92],[4526,63,93],[4598,63,87],[4662,63,87],[4747,64,87],[4807,4,88],[4874,64,91],[4948,64,91],[5020,63,89],[5089,63,92],[5160,64,88],[5232,64,90],[5309,63,90],[5381,63,89],[5446,63,88],[5518,63,90],[5587,64,92],[5663,63,93],[5729,64,87],[5807,64,93],[5874,64,87],[5938,63,90],[6013,64,87],[6078,64,90],[6149,64,89],[6221,64,90],[6301,63,88],[6367,64,92],[6445,63,92],[6517,64,88],[6588,63,87],[6659,64,88],[6717,6,87],[6795,63,93],[6870,64,91],[6935,63,93],[7003,64,92]],"cb":[[5,64,92],[71,64,96],[149,64,98],[216,64,98],[284,63,96],[352,64,92],[425,63,97],[494,64,96],[565,64,97],[630,63,98],[701,64,97],[783,63,96],[850,64,98],[919,64,95],[998,63,97],[1060,1,93],[1140,63,98],[1208,63,93],[1275,64,93],[1348,64,97],[1413,63,93],[1486,63,93],[1558,63,93],[1632,63,94],[1705,64,92],[1774,64,98],[1845,63,93],[1908,63,95],[1988,64,97],[2049,3,92],[2129,64,94],[2192,1,92],[2263,63,94],[2331,64,93],[2411,63,98],[2479,63,97],[2547,64,95],[2610,1,97],[2682,63,94],[2756,64,97],[2835,63,98],[2900,64,94],[2968,64,92],[3037,63,94],[3111,64,96],[3178,63,97],[3256,63,92],[3322,63,97],[3398,63,92],[3466,63,96],[3531,64,92],[3614,63,95],[3675,1,95],[3751,64,93],[3822,64,93],[3891,63,94],[3969,64,92],[4028,5,94],[4100,64,92],[4173,63,92],[4243,63,96],[4320,64,97],[4385,64,96],[4454,64,97],[4526,64,93],[4594,64,97],[4665,64,93],[4735,63,98],[4806,63,97],[4888,64,97],[4961,63,95],[5017,6,94],[5098,63,93],[5161,64,93],[5242,63,93],[5310,63,94],[5376,64,93],[5452,63,98],[5511,4,97],[5586,63,93],[5659,64,96],[5738,64,98],[5806,64,95],[5876,63,97],[5938,1,92],[6021,63,98],[6080,4,96],[6162,64,96],[6230,64,94],[6297,63,97],[6374,63,95],[6445,64,97],[6507,3,98],[6583,63,96],[6644,1,93],[6720,64,93],[6790,63,98],[6862,63,98],[6938,64,92],[7003,63,94]],"fl":[[74993,566,85],[76125,566,83],[77263,566,88],[78401,566,82],[79533,566,84],[80652,566,86],[81788,566,85],[82929,566,83],[84063,566,86],[85186,566,86],[86317,566,84],[87460,566,82],[88587,566,84],[89714,566,83],[90850,566,84],[91983,566,84],[93109,566,85],[94241,566,83],[95377,566,84],[96501,566,84],[97640,566,87],[98776,566,86],[99908,566,88],[101044,566,86],[102166,566,82],[103294,566,85],[104440,566,87],[175595,1200,49],[178002,1200,50],[180393,1200,48],[182800,1200,51],[185203,1200,50],[187597,1199,50],[189998,1200,51],[192402,1200,50],[194797,1200,52],[197203,1199,52],[199602,1199,53],[202003,1200,47],[204392,1200,52],[206799,1200,47],[209207,1199,47],[211602,1199,50],[214004,1200,51],[216392,1200,50],[218799,1200,47],[221195,1200,48],[223595,1200,49],[225992,1200,50],[228402,1200,50],[230791,1200,47],[233203,1199,52],[315000,566,90],[316131,566,92],[317257,566,89],[318399,566,88],[319520,566,89],[320659,566,92],[321788,566,89],[322927,566,91],[324054,566,89],[325184,566,87],[326317,566,88],[327448,566,93],[328579,566,92],[329711,566,90],[330844,566,87],[331978,566,89],[333107,566,90],[334242,566,91],[335380,566,90],[336501,566,92],[337642,566,91],[338779,566,89],[339905,566,92],[341034,566,92],[342167,566,88],[343306,566,91],[344435,566,89],[345566,566,90],[346689,566,89],[347836,566,91],[348962,566,90],[350093,566,92],[351225,566,88],[352359,566,88],[353483,566,93],[354622,566,90],[355754,566,93],[356879,566,90],[358014,566,88],[359156,566,92],[360286,566,91],[361417,566,93],[362546,566,92],[363669,566,92],[364815,566,88]],"ob":[[74993,566,78],[76129,566,83],[77272,566,82],[78391,566,82],[79536,566,82],[80661,566,81],[81788,566,82],[82924,566,77],[84063,566,83],[85183,566,77],[86326,566,80],[87455,566,80],[88592,566,83],[89713,566,78],[90846,566,78],[91981,566,78],[93109,566,79],[94249,566,78],[95377,566,78],[96505,566,83],[97644,566,78],[98772,566,77],[99910,566,78],[101041,566,80],[102163,566,82],[103308,566,81],[104439,566,77],[315004,566,85],[316126,566,83],[317254,566,86],[318389,566,82],[319527,566,85],[320663,566,84],[321794,566,85],[322918,566,88],[324054,566,84],[325192,566,86],[326313,566,83],[327447,566,86],[328586,566,88],[329717,566,82],[330845,566,82],[331981,566,88],[333113,566,88],[334247,566,86],[335381,566,88],[336514,566,86],[337642,566,88],[338771,566,82],[339908,566,87],[341032,566,87],[342160,566,82],[343297,566,82],[344434,566,87],[345559,566,88],[346691,566,84],[347823,566,84],[348961,566,87],[350089,566,86],[351219,566,88],[352355,566,86],[353482,566,85],[354615,566,82],[355760,566,83],[356877,566,82],[358023,566,83],[359156,566,83],[360279,566,88],[361413,566,87],[362537,566,83],[363676,566,84],[364814,566,82]],"cl":[[34998,566,72],[37267,566,71],[39531,566,72],[41790,566,67],[44054,566,67],[46322,566,67],[48586,566,69],[50844,566,72],[53106,566,71],[55372,566,70],[57647,566,70],[59899,566,70],[62162,566,68],[64426,566,72],[66692,566,68],[68964,566,68],[71220,566,69],[73491,566,72],[315003,566,87],[316126,566,88],[317259,566,87],[318394,566,84],[319520,566,84],[320665,566,83],[321791,566,88],[322917,566,88],[324053,566,87],[325186,566,86],[326318,566,87],[327445,566,84],[328585,566,84],[329719,566,84],[330844,566,85],[331976,566,83],[333112,566,83],[334244,566,86],[335369,566,82],[336510,566,84],[337631,566,88],[338773,566,88],[339899,566,84],[341034,566,82],[342164,566,85],[343301,566,84],[344430,566,83],[345560,566,82],[346693,566,82],[347824,566,88],[348968,566,87],[350100,566,88],[351228,566,84],[352360,566,82],[353495,566,84],[354624,566,83],[355750,566,85],[356882,566,87],[358018,566,86],[359147,566,83],[360274,566,83],[361408,566,82],[362538,566,82],[363683,566,82],[364811,566,88]],"bn":[[314995,566,90],[316132,566,92],[317267,566,91],[318394,566,89],[319526,566,89],[320662,566,92],[321798,566,92],[322929,566,92],[324049,566,93],[325183,566,93],[326326,566,89],[327456,566,89],[328584,566,93],[329717,566,87],[330849,566,88],[331974,566,93],[333110,566,89],[334248,566,92],[335378,566,91],[336510,566,90],[337642,566,88],[338774,566,91],[339899,566,92],[341041,566,88],[342173,566,88],[343307,566,88],[344432,566,93],[345561,566,89],[346698,566,91],[347830,566,91],[348953,566,92],[350093,566,88],[351232,566,90],[352355,566,88],[353488,566,89],[354624,566,89],[355760,566,92],[356891,566,87],[358020,566,91],[359147,566,87],[360283,566,87],[361413,566,91],[362540,566,89],[363678,566,92],[364817,566,87]],"hn":[[0,138,102],[2259,142,102],[4531,142,103],[6794,142,100],[9063,142,101],[11326,142,97],[13578,142,100],[15845,142,101],[18105,142,98],[20375,142,98],[22649,142,98],[24899,142,102],[27167,142,97],[29442,142,97],[31697,142,100],[33962,142,99],[75005,566,103],[76131,566,107],[77264,566,107],[78390,566,110],[79527,566,111],[80658,566,107],[81786,566,107],[82924,566,110],[84056,566,108],[85181,566,108],[86317,566,113],[87447,566,113],[88579,566,107],[89712,566,107],[90849,566,106],[91980,566,109],[93105,566,112],[94246,566,111],[95374,566,103],[96507,566,107],[97635,566,106],[98772,566,110],[99901,566,107],[101036,566,109],[102172,566,112],[103296,566,108],[104439,566,108],[145000,566,108],[146130,566,113],[147256,566,113],[148399,566,109],[149530,566,107],[150661,566,107],[151788,566,111],[152926,566,108],[154048,566,110],[155195,566,109],[156321,566,110],[157458,566,108],[158585,566,110],[159713,566,112],[160851,566,111],[161984,566,107],[163106,566,112],[164252,566,110],[165382,566,108],[166512,566,108],[167638,566,112],[168776,566,113],[169911,566,113],[171041,566,113],[172166,566,109],[173301,566,108],[174437,566,113]],"tp":[[75005,566,113],[76136,566,109],[77256,566,110],[78400,566,109],[79527,566,110],[80656,566,108],[81797,566,111],[82919,566,107],[84064,566,108],[85190,566,112],[86314,566,107],[87455,566,108],[88583,566,111],[89722,566,111],[90856,566,107],[91989,566,107],[93115,566,109],[94248,566,108],[95380,566,109],[96510,566,111],[97641,566,107],[98771,566,113],[99903,566,107],[101034,566,113],[102172,566,108],[103308,566,109],[104431,566,113]],"tb":[[0,136,95],[2265,142,98],[4533,142,96],[6792,142,93],[9059,142,93],[11318,142,96],[13591,142,97],[15845,142,97],[18118,142,95],[20382,142,94],[22647,142,93],[24911,142,93],[27165,142,97],[29438,142,92],[31690,142,94],[33960,142,96],[75005,566,113],[76136,566,109],[77256,566,110],[78400,566,109],[79527,566,110],[80656,566,108],[81797,566,111],[82919,566,107],[84064,566,108],[85190,566,112],[86314,566,107],[87455,566,108],[88583,566,111],[89722,566,111],[90856,566,107],[91989,566,107],[93115,566,109],[94248,566,108],[95380,566,109],[96510,566,111],[97641,566,107],[98771,566,113],[99903,566,107],[101034,566,113],[102172,566,108],[103308,566,109],[104431,566,113],[315003,566,118],[316123,566,112],[317259,566,115],[318394,566,115],[319526,566,112],[320662,566,116],[321788,566,118],[322930,566,114],[324053,566,115],[325184,566,113],[326324,566,117],[327445,566,112],[328586,566,118],[329715,566,114],[330842,566,117],[331983,566,112],[333106,566,112],[334248,566,115],[335370,566,114]],"tu":[[0,142,91],[2258,142,92],[4523,142,87],[6798,142,90],[9063,142,93],[11326,142,92],[13577,142,90],[15846,142,90],[18112,142,92],[20372,142,93],[22644,142,92],[24912,142,89],[27168,142,93],[29438,142,87],[31693,142,90],[33969,142,91],[74997,1132,100],[76129,1132,99],[78391,1132,100],[79528,1132,98],[82926,1132,99],[84059,1132,101],[87449,1132,98],[88585,1132,100],[89723,1132,98],[94248,1132,99],[96507,1132,103],[97641,1132,102],[99908,1132,102],[102172,1132,103],[103308,1132,103],[144999,1132,102],[147262,1132,98],[149530,1132,98],[151797,1132,97],[154052,1132,102],[155188,1132,102],[156325,1132,100],[160855,1132,101],[165382,1132,101],[166515,1132,102],[168771,1132,100],[171042,1132,100],[174427,1132,98],[315004,1132,107],[316138,1132,105],[320661,1132,106],[322921,1132,104],[325193,1132,102],[326326,1132,104],[328579,1132,103],[329716,1132,107],[331984,1132,107],[334246,1132,108],[336501,1132,103],[337644,1132,107],[341033,1132,105],[342169,1132,106],[344434,1132,107],[347821,1132,105]],"hp":[[174995,601,65],[175300,601,66],[175604,599,64],[175907,599,66],[176195,599,63],[176500,599,68],[176801,599,66],[177099,599,67],[177397,599,63],[177704,599,66],[177994,599,67],[178294,599,62],[178597,601,67],[178901,599,66],[179505,601,66],[179797,599,62],[180104,601,66],[180396,601,63],[180697,599,62],[181007,599,63],[181303,601,63],[181900,599,63],[182192,599,62],[182500,599,63],[182806,601,64],[183100,601,65],[183393,599,65],[183706,601,67],[183996,599,67],[184300,599,65],[184606,599,66],[184906,599,64],[185204,599,62],[185495,599,68],[185792,601,67],[186098,599,64],[186398,599,64],[186695,599,63],[186994,599,66],[187295,601,64],[187600,601,68],[187903,599,64],[188197,601,62],[188507,601,62],[188799,599,68],[189102,601,66],[189403,599,65],[189702,601,68],[189993,601,63],[190304,599,62],[190598,599,67],[190907,599,66],[191201,599,64],[191496,599,67],[191795,599,68],[192102,601,68],[192402,601,63],[192697,599,66],[192996,601,65],[193299,601,62],[193598,599,68],[193897,599,64],[194203,599,62],[194499,599,65],[194797,601,66],[195101,601,65],[195406,601,66],[195699,601,67],[196294,601,67],[196604,599,66],[196905,599,66],[197199,599,65],[197502,601,65],[197804,599,63],[198093,601,68],[198692,601,66],[199007,601,68],[199292,601,65],[199597,599,64],[199901,601,67],[200191,599,66],[200507,601,64],[200805,599,62],[201092,599,66],[201394,599,68],[201700,599,64],[201995,599,67],[202291,601,64],[202606,599,63],[202892,601,66],[203495,599,62],[203791,601,63],[204092,599,68],[204392,599,62],[204700,599,67]],"ce":[[174999,1199,54],[177402,1200,56],[179799,1200,53],[182201,1200,54],[184606,1200,52],[186993,1200,52],[189394,1199,55],[191792,1199,54],[194199,1199,55],[196604,1200,57],[198994,1200,57],[201399,1200,55],[203791,1200,53],[206203,1200,56],[208600,1199,52],[211004,1199,57],[213398,1200,54],[215804,1200,55],[218197,1200,54],[220593,1199,54],[223001,1200,56],[225396,1199,53],[227796,1200,53],[230206,1200,55],[232603,1199,53]],"ti":[[0,8000,30],[9121,300,108],[10279,301,101],[11399,300,105],[11964,300,92],[24999,7001,33],[32000,3000,127],[35000,226,91],[35562,226,86],[35862,226,92],[36422,226,79],[36678,226,79],[37261,226,79],[37562,226,81],[38133,226,85],[38390,226,86],[38948,226,79],[39229,226,91],[39827,226,82],[40109,226,87],[40668,226,86],[40959,226,87],[41514,226,85],[41809,226,91],[42365,226,92],[42657,226,90],[43194,226,82],[43486,226,85],[44075,226,82],[44345,226,90],[44892,226,88],[45179,226,89],[45754,226,90],[46019,226,80],[46591,226,89],[46899,226,87],[47451,226,77],[47721,226,83],[48293,226,87],[48580,226,82],[49153,226,85],[49452,226,78],[49996,226,86],[50288,226,87],[50838,226,91],[51125,226,93],[51689,226,79],[51961,226,85],[52558,226,85],[52842,226,87],[53416,226,77],[53669,226,78],[54253,226,83],[54514,226,86],[55105,226,78],[55393,226,87],[55958,226,78],[56225,226,79],[56798,226,89],[57063,226,85],[57652,226,81],[57931,226,88],[58472,226,88],[58764,226,79],[59321,226,85],[59615,226,78],[60208,226,84],[60475,226,80],[61052,226,77],[61316,226,89],[61873,226,90],[62185,226,80],[62749,226,84],[63032,226,87],[63603,226,90],[63887,226,81],[64423,226,90],[64713,226,85],[65269,226,86],[65566,226,81],[66113,226,88],[66397,226,91],[66999,226,88],[67272,226,90],[67829,226,78],[68126,226,84],[68683,226,81],[68955,226,84],[69540,226,79],[69815,226,87],[70387,226,84],[70670,226,91],[71224,226,88],[71525,226,92],[72069,226,90],[72347,226,82],[72941,226,92]]};

    // Instrument to section mapping
    const SECTIONS = {
        v1: 'strings', v2: 'strings', va: 'strings', vc: 'strings', cb: 'strings',
        fl: 'woodwinds', ob: 'woodwinds', cl: 'woodwinds', bn: 'woodwinds',
        hn: 'brass', tp: 'brass', tb: 'brass', tu: 'brass',
        ti: 'percussion', hp: 'percussion', ce: 'percussion'
    };

    // =========================================================================
    // DOM ELEMENTS
    // =========================================================================
    
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const timeDisplay = document.getElementById('time');
    const volumeSlider = document.getElementById('volume');
    const volumeIcon = document.getElementById('volume-icon');
    const instruments = document.querySelectorAll('.instrument');
    const sectionMeters = document.querySelectorAll('.section-meter');

    // Duration in seconds
    const DURATION = 402;
    
    // Track note indices for each instrument
    const noteIndices = {};
    Object.keys(NOTES).forEach(id => noteIndices[id] = 0);

    // Section activity tracking
    const sectionActivity = { strings: 0, woodwinds: 0, brass: 0, percussion: 0 };

    // =========================================================================
    // PLAYBACK CONTROL
    // =========================================================================
    
    let isPlaying = false;
    let animationId = null;

    function togglePlay() {
        if (isPlaying) {
            audio.pause();
            playBtn.classList.remove('playing');
            playBtn.innerHTML = 'â–¶';
            cancelAnimationFrame(animationId);
        } else {
            audio.play().catch(e => console.log('Audio play failed:', e));
            playBtn.classList.add('playing');
            playBtn.innerHTML = 'â¸';
            updateVisualization();
        }
        isPlaying = !isPlaying;
    }

    playBtn.addEventListener('click', togglePlay);

    // Volume control
    volumeSlider.addEventListener('input', (e) => {
        const vol = e.target.value / 100;
        audio.volume = vol;
        volumeIcon.textContent = vol === 0 ? 'ğŸ”‡' : vol < 0.5 ? 'ğŸ”‰' : 'ğŸ”Š';
    });
    audio.volume = 0.7;

    volumeIcon.addEventListener('click', () => {
        audio.muted = !audio.muted;
        volumeIcon.textContent = audio.muted ? 'ğŸ”‡' : 'ğŸ”Š';
    });

    // Seek to position and recalculate note indices
    function seekTo(timeMs) {
        // Recalculate all note indices for the new position
        Object.keys(NOTES).forEach(id => {
            const notes = NOTES[id];
            let idx = 0;
            for (let i = 0; i < notes.length; i++) {
                if (notes[i][0] <= timeMs) {
                    idx = i;
                } else {
                    break;
                }
            }
            noteIndices[id] = idx;
        });
        
        // Update visualization immediately even when paused
        updateVisualizationFrame();
    }

    // Progress bar click
    progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        const newTime = pct * DURATION;
        audio.currentTime = newTime;
        seekTo(newTime * 1000);
    });

    // Handle seeking from any source
    audio.addEventListener('seeked', () => {
        seekTo(audio.currentTime * 1000);
    });

    // =========================================================================
    // FORMAT TIME
    // =========================================================================
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // =========================================================================
    // VISUALIZATION UPDATE â€” Millisecond Accurate
    // =========================================================================
    
    // Single frame update (can be called when paused)
    function updateVisualizationFrame() {
        const currentTimeMs = audio.currentTime * 1000;
        const currentTimeSec = audio.currentTime;

        // Update progress
        const progress = (currentTimeSec / DURATION) * 100;
        progressFill.style.width = `${Math.min(progress, 100)}%`;
        timeDisplay.textContent = `${formatTime(currentTimeSec)} / ${formatTime(DURATION)}`;

        // Reset section activity
        Object.keys(sectionActivity).forEach(k => sectionActivity[k] = 0);

        // Check each instrument for note hits
        Object.keys(NOTES).forEach(instId => {
            const notes = NOTES[instId];
            const inst = document.querySelector(`[data-id="${instId}"]`);
            if (!inst || !notes) return;

            // Find notes that should be playing now
            let isCurrentlyPlaying = false;
            
            // Search around current index for active notes
            const searchStart = Math.max(0, noteIndices[instId] - 5);
            const searchEnd = Math.min(notes.length, noteIndices[instId] + 20);
            
            for (let i = searchStart; i < searchEnd; i++) {
                const [start, dur, vel] = notes[i];
                
                // Note is currently playing (with small tolerance)
                if (currentTimeMs >= start - 10 && currentTimeMs <= start + dur + 50) {
                    isCurrentlyPlaying = true;
                    // Update section activity based on velocity
                    const section = SECTIONS[instId];
                    sectionActivity[section] = Math.max(sectionActivity[section], vel / 127);
                }
            }

            // Apply playing state
            if (isCurrentlyPlaying) {
                if (!inst.classList.contains('playing')) {
                    inst.classList.add('playing');
                }
            } else {
                inst.classList.remove('playing');
            }
        });

        // Update section meters
        sectionMeters.forEach(meter => {
            const section = meter.dataset.section;
            const fill = meter.querySelector('.section-meter-fill');
            const activity = sectionActivity[section] || 0;
            fill.style.width = `${activity * 100}%`;
        });
    }

    // Animation loop for playback
    function updateVisualization() {
        updateVisualizationFrame();
        
        // Advance note indices during playback
        const currentTimeMs = audio.currentTime * 1000;
        Object.keys(NOTES).forEach(instId => {
            const notes = NOTES[instId];
            while (noteIndices[instId] < notes.length - 1 && 
                   notes[noteIndices[instId]][0] + notes[noteIndices[instId]][1] < currentTimeMs - 100) {
                noteIndices[instId]++;
            }
        });

        // Continue animation if playing
        if (!audio.paused) {
            animationId = requestAnimationFrame(updateVisualization);
        }
    }
    
    // Update on timeupdate (for scrubbing while paused)
    audio.addEventListener('timeupdate', () => {
        if (audio.paused) {
            updateVisualizationFrame();
        }
    });

    // Audio events
    audio.addEventListener('ended', () => {
        isPlaying = false;
        playBtn.classList.remove('playing');
        playBtn.innerHTML = 'â–¶';
        cancelAnimationFrame(animationId);
        // Reset indices
        Object.keys(noteIndices).forEach(id => noteIndices[id] = 0);
        progressFill.style.width = '0%';
    });

    audio.addEventListener('loadedmetadata', () => {
        const dur = audio.duration || DURATION;
        timeDisplay.textContent = `0:00 / ${formatTime(dur)}`;
        console.log('âœ“ Audio loaded:', formatTime(dur));
    });

    audio.addEventListener('canplaythrough', () => {
        console.log('âœ“ Audio ready to play');
        playBtn.style.opacity = '1';
    });

    audio.addEventListener('error', (e) => {
        console.error('âœ— Audio error:', e);
        timeDisplay.textContent = 'Audio load error';
        playBtn.innerHTML = 'âš ';
    });

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            togglePlay();
        }
        // Arrow keys for scrubbing
        if (e.code === 'ArrowRight') {
            e.preventDefault();
            audio.currentTime = Math.min(audio.currentTime + 5, DURATION);
        }
        if (e.code === 'ArrowLeft') {
            e.preventDefault();
            audio.currentTime = Math.max(audio.currentTime - 5, 0);
        }
    });

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    
    // Initial state
    playBtn.style.opacity = '0.5';
    timeDisplay.textContent = `0:00 / ${formatTime(DURATION)}`;
    
    // Preload audio
    audio.load();
    
    console.log('ğŸ» Master of Puppets â€” A Fantasia');
    console.log('   Instruments:', Object.keys(NOTES).length);
    console.log('   Total notes:', Object.values(NOTES).reduce((a, b) => a + b.length, 0));
    console.log('   Duration:', formatTime(DURATION));
    console.log('   Arrow keys: â† â†’ to scrub Â±5s');
    console.log('   Space: Play/Pause');
    console.log('   h(x) â‰¥ 0');
})();
</script>

</body>
</html>
